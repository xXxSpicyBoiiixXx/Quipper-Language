<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Haskell code</title>
</head>
<body>
<pre><a name="line-1"></a><font color=Blue><i>{-# LANGUAGE BangPatterns #-}</i></font>
<a name="line-2"></a><font color=Blue><i>{-# LANGUAGE MonadComprehensions #-}</i></font>
<a name="line-3"></a><font color=Blue><i>{-# LANGUAGE DoAndIfThenElse #-}</i></font>
<a name="line-4"></a>
<a name="line-5"></a><font color=Blue><i>-- | This module contains the core of the classical circuit</i></font>
<a name="line-6"></a><font color=Blue><i>-- optimization algorithm.</i></font>
<a name="line-7"></a><font color=Green><u>module</u></font> Quipper.Libraries.ClassicalOptim.Simplification <font color=Green><u>where</u></font>
<a name="line-8"></a>
<a name="line-9"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data.Map <font color=Green><u>as</u></font> M
<a name="line-10"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data.List <font color=Green><u>as</u></font> L
<a name="line-11"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data.Set <font color=Green><u>as</u></font> S
<a name="line-12"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data.IntSet <font color=Green><u>as</u></font> IS
<a name="line-13"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data.IntMap.Strict <font color=Green><u>as</u></font> IM <font color=Blue><i>{- containers-0.5.2.1 -}</i></font>
<a name="line-14"></a>
<a name="line-15"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Control.DeepSeq <font color=Green><u>as</u></font> Seq
<a name="line-16"></a>
<a name="line-17"></a><font color=Green><u>import</u></font> Control.Applicative <font color=Cyan>(</font>Applicative<font color=Cyan>(</font><font color=Red>..</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-18"></a><font color=Green><u>import</u></font> Control.Monad <font color=Cyan>(</font>liftM<font color=Cyan>,</font> ap<font color=Cyan>)</font>
<a name="line-19"></a>
<a name="line-20"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Quipper.Utils.Auxiliary <font color=Green><u>as</u></font> Q
<a name="line-21"></a>
<a name="line-22"></a><font color=Green><u>import</u></font> Quipper.Libraries.ClassicalOptim.Circuit
<a name="line-23"></a><font color=Green><u>import</u></font> Quipper.Libraries.ClassicalOptim.AlgExp
<a name="line-24"></a>
<a name="line-25"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-26"></a><font color=Blue><i>-- * Auxiliary definitions</i></font>
<a name="line-27"></a>
<a name="line-28"></a><a name="trace"></a><font color=Blue><i>-- | Internal definition of a trace, for debugging purposes. This is a</i></font>
<a name="line-29"></a><font color=Blue><i>-- no-op, but can be replaced to turn on debugging.</i></font>
<a name="line-30"></a><font color=Blue>trace</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> b <font color=Red>-&gt;</font> b
<a name="line-31"></a><font color=Blue>trace</font> a b <font color=Red>=</font> b
<a name="line-32"></a>
<a name="line-33"></a><a name="moveWire"></a><font color=Blue><i>-- | Change a wire ID in a gate. The first two arguments are the old</i></font>
<a name="line-34"></a><font color=Blue><i>-- and the new wire ID.</i></font>
<a name="line-35"></a><font color=Blue>moveWire</font> <font color=Red>::</font> Wire <font color=Red>-&gt;</font> Wire <font color=Red>-&gt;</font> Gate <font color=Red>-&gt;</font> Gate
<a name="line-36"></a><font color=Blue>moveWire</font> from to NoOp <font color=Red>=</font> NoOp
<a name="line-37"></a><font color=Blue>moveWire</font> from to <font color=Cyan>(</font>Init b w<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>w <font color=Cyan>==</font> from<font color=Cyan>)</font> <font color=Green><u>then</u></font> error <font color=Magenta>"moveWire"</font> <font color=Green><u>else</u></font> <font color=Cyan>(</font>Init b w<font color=Cyan>)</font>
<a name="line-38"></a><font color=Blue>moveWire</font> from to <font color=Cyan>(</font>Cnot w ctls<font color=Cyan>)</font> <font color=Red>=</font> Cnot w' ctls'
<a name="line-39"></a>   <font color=Green><u>where</u></font>
<a name="line-40"></a>   w' <font color=Red>=</font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>from <font color=Cyan>==</font> w<font color=Cyan>)</font> <font color=Green><u>then</u></font> to <font color=Green><u>else</u></font> w
<a name="line-41"></a>   ctls' <font color=Red>=</font> map moveCtls ctls
<a name="line-42"></a>   moveCtls <font color=Cyan>(</font>w<font color=Cyan>,</font>b<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>from <font color=Cyan>==</font> w<font color=Cyan>)</font> <font color=Green><u>then</u></font> <font color=Cyan>(</font>to<font color=Cyan>,</font>b<font color=Cyan>)</font> <font color=Green><u>else</u></font> <font color=Cyan>(</font>w<font color=Cyan>,</font>b<font color=Cyan>)</font>
<a name="line-43"></a>
<a name="line-44"></a><a name="flipCtl"></a><font color=Blue><i>-- | Flip the control on the given wire (from positive to negative or</i></font>
<a name="line-45"></a><font color=Blue><i>-- vice versa).</i></font>
<a name="line-46"></a><font color=Blue>flipCtl</font> <font color=Red>::</font> Wire <font color=Red>-&gt;</font> Gate <font color=Red>-&gt;</font> Gate
<a name="line-47"></a><font color=Blue>flipCtl</font> <font color=Green><u>_</u></font> NoOp <font color=Red>=</font> NoOp
<a name="line-48"></a><font color=Blue>flipCtl</font> <font color=Green><u>_</u></font> <font color=Cyan>(</font>Init b w<font color=Cyan>)</font> <font color=Red>=</font> Init b w
<a name="line-49"></a><font color=Blue>flipCtl</font> w <font color=Cyan>(</font>Cnot w' ctls<font color=Cyan>)</font> <font color=Red>=</font> Cnot w' <font color=Cyan>$</font> map <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x<font color=Cyan>,</font>b<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>x <font color=Cyan>==</font> w<font color=Cyan>)</font> <font color=Green><u>then</u></font> <font color=Cyan>(</font>x<font color=Cyan>,</font>not b<font color=Cyan>)</font> <font color=Green><u>else</u></font> <font color=Cyan>(</font>x<font color=Cyan>,</font>b<font color=Cyan>)</font><font color=Cyan>)</font> ctls
<a name="line-50"></a>
<a name="line-51"></a><a name="moveWireFlip"></a><font color=Blue><i>-- | Change a wire ID in a gate and flip the potential control.</i></font>
<a name="line-52"></a><font color=Blue>moveWireFlip</font> <font color=Red>::</font> Wire <font color=Red>-&gt;</font> Wire <font color=Red>-&gt;</font> Gate <font color=Red>-&gt;</font> Gate
<a name="line-53"></a><font color=Blue>moveWireFlip</font> from to NoOp <font color=Red>=</font> NoOp
<a name="line-54"></a><font color=Blue>moveWireFlip</font> from to <font color=Cyan>(</font>Init b w<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>w <font color=Cyan>==</font> from<font color=Cyan>)</font> <font color=Green><u>then</u></font> error <font color=Magenta>"moveWire"</font> <font color=Green><u>else</u></font> <font color=Cyan>(</font>Init b w<font color=Cyan>)</font>
<a name="line-55"></a><font color=Blue>moveWireFlip</font> from to <font color=Cyan>(</font>Cnot w ctls<font color=Cyan>)</font> <font color=Red>=</font> Cnot w' ctls'
<a name="line-56"></a>   <font color=Green><u>where</u></font>
<a name="line-57"></a>   w' <font color=Red>=</font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>from <font color=Cyan>==</font> w<font color=Cyan>)</font> <font color=Green><u>then</u></font> to <font color=Green><u>else</u></font> w
<a name="line-58"></a>   ctls' <font color=Red>=</font> map moveCtls ctls
<a name="line-59"></a>   moveCtls <font color=Cyan>(</font>w<font color=Cyan>,</font>b<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>from <font color=Cyan>==</font> w<font color=Cyan>)</font> <font color=Green><u>then</u></font> <font color=Cyan>(</font>to<font color=Cyan>,</font>b<font color=Cyan>)</font> <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>to <font color=Cyan>==</font> w<font color=Cyan>)</font> <font color=Green><u>then</u></font> <font color=Cyan>(</font>w<font color=Cyan>,</font>not b<font color=Cyan>)</font> <font color=Green><u>else</u></font> <font color=Cyan>(</font>w<font color=Cyan>,</font>b<font color=Cyan>)</font>
<a name="line-60"></a>
<a name="line-61"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-62"></a><font color=Blue><i>-- * Small, simple optimizations</i></font>
<a name="line-63"></a>
<a name="line-64"></a><a name="suppress_garbage"></a><font color=Blue><i>-- | Suppress gates acting on garbage wires, i.e., wires that are not in the input set. </i></font>
<a name="line-65"></a><font color=Blue>suppress_garbage</font> <font color=Red>::</font> <font color=Red>[</font>Gate<font color=Red>]</font> <font color=Red>-&gt;</font> IS.IntSet <font color=Red>-&gt;</font> <font color=Red>[</font>Gate<font color=Red>]</font>
<a name="line-66"></a>
<a name="line-67"></a><font color=Blue>suppress_garbage</font> <font color=Cyan>(</font><font color=Cyan>(</font>Cnot w ctls<font color=Cyan>)</font><font color=Red><b>:</b></font>gs<font color=Cyan>)</font> used <font color=Red>=</font> 
<a name="line-68"></a>  <font color=Green><u>if</u></font> <font color=Cyan>(</font>IS.member w used<font color=Cyan>)</font> <font color=Green><u>then</u></font> g<font color=Red><b>:</b></font>gs1 <font color=Green><u>else</u></font> gs2
<a name="line-69"></a>  <font color=Green><u>where</u></font>
<a name="line-70"></a>    g <font color=Red>=</font> Cnot w ctls
<a name="line-71"></a>    gs1 <font color=Red>=</font> suppress_garbage gs <font color=Cyan>$</font> IS.union <font color=Cyan>(</font>IS.insert w used<font color=Cyan>)</font> <font color=Cyan>$</font> IS.fromList <font color=Cyan>$</font> L.map fst ctls
<a name="line-72"></a>    gs2 <font color=Red>=</font> suppress_garbage gs used
<a name="line-73"></a>
<a name="line-74"></a><font color=Blue>suppress_garbage</font> <font color=Cyan>(</font>g<font color=Red><b>:</b></font>gs<font color=Cyan>)</font> used <font color=Red>=</font> g<font color=Red><b>:</b></font><font color=Cyan>(</font>suppress_garbage gs used<font color=Cyan>)</font>
<a name="line-75"></a>
<a name="line-76"></a><font color=Blue>suppress_garbage</font> [] <font color=Green><u>_</u></font> <font color=Red>=</font> []
<a name="line-77"></a>
<a name="line-78"></a>
<a name="line-79"></a><a name="suppressGarbageGates"></a><font color=Blue><i>-- | Like 'suppress_garbage', but packaged in a manner that is friendly for composition.</i></font>
<a name="line-80"></a><font color=Blue>suppressGarbageGates</font> <font color=Red>::</font> <font color=Cyan>(</font><font color=Red>[</font>Gate<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Gate<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-81"></a>
<a name="line-82"></a><font color=Blue>suppressGarbageGates</font> <font color=Cyan>(</font>gs<font color=Cyan>,</font>out<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>reverse <font color=Cyan>$</font> suppress_garbage <font color=Cyan>(</font>reverse gs<font color=Cyan>)</font> <font color=Cyan>$</font> IS.fromList out<font color=Cyan>,</font> out<font color=Cyan>)</font>
<a name="line-83"></a>
<a name="line-84"></a>
<a name="line-85"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-86"></a><font color=Blue><i>-- * Compression of wire numbering</i></font>
<a name="line-87"></a>
<a name="line-88"></a><font color=Blue><i>-- $ As the optimization process goes on, many /init/ gates will end</i></font>
<a name="line-89"></a><font color=Blue><i>-- up being discarded. The function 'compressWires' compacts the wire</i></font>
<a name="line-90"></a><font color=Blue><i>-- numbering scheme to make a smaller circuit.</i></font>
<a name="line-91"></a>
<a name="line-92"></a><a name="getAllWires"></a><font color=Blue><i>-- | Get the set of all wires used by the circuit.</i></font>
<a name="line-93"></a><font color=Blue>getAllWires</font> <font color=Red>::</font> <font color=Red>[</font>Gate<font color=Red>]</font> <font color=Red>-&gt;</font> IS.IntSet
<a name="line-94"></a><font color=Blue>getAllWires</font> gs <font color=Red>=</font> L.foldl' IS.union IS.empty <font color=Cyan>$</font> L.map aux gs
<a name="line-95"></a>  <font color=Green><u>where</u></font>
<a name="line-96"></a>    aux <font color=Cyan>(</font>Cnot w ctls<font color=Cyan>)</font> <font color=Red>=</font> IS.insert w <font color=Cyan>$</font> L.foldl' <font color=Cyan>(</font>flip IS.insert<font color=Cyan>)</font> IS.empty <font color=Cyan>$</font> L.map fst ctls
<a name="line-97"></a>    aux <font color=Cyan>(</font>Init <font color=Green><u>_</u></font> w<font color=Cyan>)</font> <font color=Red>=</font> IS.singleton w
<a name="line-98"></a>    aux NoOp <font color=Red>=</font> IS.empty
<a name="line-99"></a>
<a name="line-100"></a><a name="getInitWires"></a><font color=Blue><i>-- | Get the set of wires initialized by the circuit.</i></font>
<a name="line-101"></a><font color=Blue>getInitWires</font> <font color=Red>::</font> <font color=Red>[</font>Gate<font color=Red>]</font> <font color=Red>-&gt;</font> IS.IntSet
<a name="line-102"></a><font color=Blue>getInitWires</font> gs <font color=Red>=</font> L.foldl' IS.union IS.empty <font color=Cyan>$</font> map aux gs
<a name="line-103"></a>  <font color=Green><u>where</u></font>
<a name="line-104"></a>    aux <font color=Cyan>(</font>Cnot <font color=Green><u>_</u></font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> IS.empty
<a name="line-105"></a>    aux <font color=Cyan>(</font>Init <font color=Green><u>_</u></font> w<font color=Cyan>)</font> <font color=Red>=</font> IS.singleton w
<a name="line-106"></a>    aux NoOp <font color=Red>=</font> IS.empty
<a name="line-107"></a>
<a name="line-108"></a><a name="getInputWires"></a><font color=Blue><i>-- | Get the set of input wires, i.e., the ones that are used but not initialized.</i></font>
<a name="line-109"></a><font color=Blue>getInputWires</font> <font color=Red>::</font> <font color=Red>[</font>Gate<font color=Red>]</font> <font color=Red>-&gt;</font> IS.IntSet
<a name="line-110"></a><font color=Blue>getInputWires</font> gs <font color=Red>=</font> IS.difference <font color=Cyan>(</font>getAllWires gs<font color=Cyan>)</font>  <font color=Cyan>(</font>getInitWires gs<font color=Cyan>)</font>
<a name="line-111"></a>
<a name="line-112"></a><a name="compressWires"></a><font color=Blue><i>-- | Compress the wire numbering.</i></font>
<a name="line-113"></a><font color=Blue>compressWires</font> <font color=Red>::</font> <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Gate<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Gate<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-114"></a><font color=Blue>compressWires</font> inputwires <font color=Cyan>(</font>gs<font color=Cyan>,</font>output<font color=Cyan>)</font> <font color=Red>=</font>  <font color=Cyan>(</font>gs'<font color=Cyan>,</font>out'<font color=Cyan>)</font>
<a name="line-115"></a>  <font color=Green><u>where</u></font>
<a name="line-116"></a>    iws <font color=Red>=</font> getInitWires gs
<a name="line-117"></a>    begin <font color=Red>=</font> <font color=Green><u>if</u></font> inputwires <font color=Cyan>==</font> []
<a name="line-118"></a>            <font color=Green><u>then</u></font> <font color=Magenta>0</font>
<a name="line-119"></a>            <font color=Green><u>else</u></font> <font color=Magenta>1</font> <font color=Cyan>+</font> <font color=Cyan>(</font>head <font color=Cyan>$</font> reverse <font color=Cyan>$</font> L.sort inputwires<font color=Cyan>)</font>
<a name="line-120"></a>    end <font color=Red>=</font> begin <font color=Cyan>+</font> <font color=Cyan>(</font>IS.size iws<font color=Cyan>)</font>
<a name="line-121"></a>    listmap <font color=Red>=</font> zip <font color=Cyan>(</font><font color=Red>[</font><font color=Magenta>0</font><font color=Red>..</font>begin<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Red>]</font> <font color=Cyan>++</font> <font color=Cyan>(</font>IS.toAscList iws<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>[</font><font color=Magenta>0</font> <font color=Red>..</font> end<font color=Red>]</font>
<a name="line-122"></a>    remap <font color=Red>=</font> M.fromList <font color=Cyan>$</font> trace <font color=Cyan>(</font>show listmap<font color=Cyan>)</font> listmap
<a name="line-123"></a>    out' <font color=Red>=</font> map <font color=Cyan>(</font>remap M<font color=Cyan>.!</font><font color=Cyan>)</font> output
<a name="line-124"></a>    gs' <font color=Red>=</font> map <font color=Cyan>(</font>rewire remap<font color=Cyan>)</font> gs
<a name="line-125"></a>    
<a name="line-126"></a>    rewire m <font color=Cyan>(</font>Cnot w ctls<font color=Cyan>)</font> <font color=Red>=</font> Cnot <font color=Cyan>(</font>m M<font color=Cyan>.!</font> w<font color=Cyan>)</font> <font color=Cyan>$</font> map <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x<font color=Cyan>,</font>b<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>m M<font color=Cyan>.!</font> x<font color=Cyan>,</font> b<font color=Cyan>)</font><font color=Cyan>)</font> ctls
<a name="line-127"></a>    rewire m <font color=Cyan>(</font>Init b w<font color=Cyan>)</font> <font color=Red>=</font> Init b <font color=Cyan>(</font>m M<font color=Cyan>.!</font> w<font color=Cyan>)</font>
<a name="line-128"></a>    rewire m NoOp <font color=Red>=</font> NoOp
<a name="line-129"></a>
<a name="line-130"></a>
<a name="line-131"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-132"></a><font color=Blue><i>-- * A useful data structure</i></font>
<a name="line-133"></a>
<a name="line-134"></a><font color=Blue><i>-- $ When considering a particular point in a circuit (i.e., in a list</i></font>
<a name="line-135"></a><font color=Blue><i>-- of gates), to decide whether a given wire is used or controlled</i></font>
<a name="line-136"></a><font color=Blue><i>-- before or after, we keep a data-structure 'UsedWire'.</i></font>
<a name="line-137"></a>
<a name="line-138"></a><a name="GateId"></a><font color=Blue><i>-- | The type of gate IDs.</i></font>
<a name="line-139"></a><a name="GateId"></a><font color=Green><u>type</u></font> GateId <font color=Red>=</font> Int
<a name="line-140"></a>
<a name="line-141"></a><a name="GateIdSet"></a><font color=Blue><i>-- | A set of gate IDs.</i></font>
<a name="line-142"></a><a name="GateIdSet"></a><font color=Green><u>type</u></font> GateIdSet <font color=Red>=</font> IS.IntSet
<a name="line-143"></a>
<a name="line-144"></a><a name="UsedWire"></a><font color=Blue><i>-- | A map from wires to pairs of 'GateId's. The left member gives the</i></font>
<a name="line-145"></a><a name="UsedWire"></a><font color=Blue><i>-- ID of the first gate using the wire, and the right member gives the</i></font>
<a name="line-146"></a><a name="UsedWire"></a><font color=Blue><i>-- ID of the last gate using the wire.</i></font>
<a name="line-147"></a><a name="UsedWire"></a><font color=Green><u>type</u></font> UsedWire <font color=Red>=</font> IM.IntMap GateIdSet
<a name="line-148"></a>
<a name="line-149"></a><a name="gateIdFindMin"></a><font color=Blue><i>-- | Get the minimum of a set of gate IDs.</i></font>
<a name="line-150"></a><font color=Blue>gateIdFindMin</font> <font color=Red>::</font> GateIdSet <font color=Red>-&gt;</font> Maybe GateId
<a name="line-151"></a><font color=Blue>gateIdFindMin</font> g <font color=Red>=</font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>IS.null g<font color=Cyan>)</font> <font color=Green><u>then</u></font> Nothing <font color=Green><u>else</u></font> Just <font color=Cyan>(</font>IS.findMin g<font color=Cyan>)</font>
<a name="line-152"></a>
<a name="line-153"></a><a name="gateIdFindMax"></a><font color=Blue><i>-- | Get the maximum of a set of gate IDs.</i></font>
<a name="line-154"></a><font color=Blue>gateIdFindMax</font> <font color=Red>::</font> GateIdSet <font color=Red>-&gt;</font> Maybe GateId
<a name="line-155"></a><font color=Blue>gateIdFindMax</font> g <font color=Red>=</font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>IS.null g<font color=Cyan>)</font> <font color=Green><u>then</u></font> Nothing <font color=Green><u>else</u></font> Just <font color=Cyan>(</font>IS.findMax g<font color=Cyan>)</font>
<a name="line-156"></a>
<a name="line-157"></a><a name="pairUsedWire"></a><font color=Blue><i>-- | Get the pair corresponding to the given wire.</i></font>
<a name="line-158"></a><font color=Blue>pairUsedWire</font> <font color=Red>::</font> UsedWire <font color=Red>-&gt;</font> Wire <font color=Red>-&gt;</font> GateIdSet
<a name="line-159"></a><font color=Blue>pairUsedWire</font> m w <font color=Red>=</font> IM.findWithDefault IS.empty w m
<a name="line-160"></a>
<a name="line-161"></a><a name="firstUsedWire"></a><font color=Blue><i>-- | Get the first gate using the wire in the future.</i></font>
<a name="line-162"></a><font color=Blue>firstUsedWire</font> <font color=Red>::</font> UsedWire <font color=Red>-&gt;</font> Wire <font color=Red>-&gt;</font> Maybe GateId
<a name="line-163"></a><font color=Blue>firstUsedWire</font> <font color=Red>=</font> curry <font color=Cyan>$</font> gateIdFindMin <font color=Cyan>.</font> <font color=Cyan>(</font>uncurry pairUsedWire<font color=Cyan>)</font>
<a name="line-164"></a>
<a name="line-165"></a><a name="lastUsedWire"></a><font color=Blue><i>-- | Get the last gate using the wire in the past. Return 0 if none.</i></font>
<a name="line-166"></a><font color=Blue>lastUsedWire</font> <font color=Red>::</font> UsedWire <font color=Red>-&gt;</font> Wire <font color=Red>-&gt;</font> GateId
<a name="line-167"></a><font color=Blue>lastUsedWire</font> w w'<font color=Red>=</font> 
<a name="line-168"></a>  <font color=Green><u>case</u></font> <font color=Cyan>(</font>curry <font color=Cyan>$</font> gateIdFindMax <font color=Cyan>.</font> <font color=Cyan>(</font>uncurry pairUsedWire<font color=Cyan>)</font><font color=Cyan>)</font> w w' <font color=Green><u>of</u></font>
<a name="line-169"></a>    Just w <font color=Red>-&gt;</font> w
<a name="line-170"></a>    Nothing <font color=Red>-&gt;</font> <font color=Magenta>0</font>
<a name="line-171"></a>
<a name="line-172"></a><a name="nextUsedGate"></a><font color=Blue><i>-- | 'nextUsedGate' /ws/ /g/ /g/' /w/: Look for the next gate in /ws/</i></font>
<a name="line-173"></a><font color=Blue><i>-- corresponding to wire /w/, starting from /g/. Return /g/' if none.</i></font>
<a name="line-174"></a><font color=Blue>nextUsedGate</font> <font color=Red>::</font> UsedWire <font color=Red>-&gt;</font> GateId <font color=Red>-&gt;</font> GateId <font color=Red>-&gt;</font> Wire <font color=Red>-&gt;</font> GateId
<a name="line-175"></a><font color=Blue>nextUsedGate</font> ws g g' w <font color=Red>=</font>
<a name="line-176"></a>  <font color=Green><u>case</u></font> <font color=Cyan>(</font><font color=Green><u>do</u></font> gs <font color=Red>&lt;-</font> IM.lookup w ws<font color=Cyan>;</font> IS.lookupGT g gs<font color=Cyan>)</font> <font color=Green><u>of</u></font>
<a name="line-177"></a>    Just g  <font color=Red>-&gt;</font> g
<a name="line-178"></a>    Nothing <font color=Red>-&gt;</font> g'
<a name="line-179"></a>
<a name="line-180"></a><a name="circuitControlWires"></a><font color=Blue><i>-- | For each wire, find the set of gates placing a control on it.</i></font>
<a name="line-181"></a><font color=Blue>circuitControlWires</font> <font color=Red>::</font> GateId <font color=Red>-&gt;</font> <font color=Red>[</font>Gate<font color=Red>]</font> <font color=Red>-&gt;</font> UsedWire
<a name="line-182"></a><font color=Blue>circuitControlWires</font> id gs <font color=Red>=</font> aux id IM.empty gs
<a name="line-183"></a>  <font color=Green><u>where</u></font>
<a name="line-184"></a>    aux <font color=Green><u>_</u></font> m [] <font color=Red>=</font> m
<a name="line-185"></a>    aux g m <font color=Cyan>(</font>Init <font color=Green><u>_</u></font> <font color=Green><u>_</u></font><font color=Red><b>:</b></font>gs<font color=Cyan>)</font> <font color=Red>=</font> aux <font color=Cyan>(</font>g<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> m gs
<a name="line-186"></a>    aux g m <font color=Cyan>(</font><font color=Cyan>(</font>Cnot <font color=Green><u>_</u></font> ctls<font color=Cyan>)</font><font color=Red><b>:</b></font>gs<font color=Cyan>)</font> <font color=Red>=</font> aux <font color=Cyan>(</font>g<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> m' gs
<a name="line-187"></a>      <font color=Green><u>where</u></font>
<a name="line-188"></a>        wires <font color=Red>=</font> map fst ctls
<a name="line-189"></a>        m' <font color=Red>=</font> L.foldl <font color=Cyan>(</font><font color=Red>\</font>m'' w <font color=Red>-&gt;</font> IM.alter <font color=Cyan>(</font>f g<font color=Cyan>)</font> w m''<font color=Cyan>)</font> m wires
<a name="line-190"></a>        f g Nothing <font color=Red>=</font> Just <font color=Cyan>$</font> IS.singleton g
<a name="line-191"></a>        f g <font color=Cyan>(</font>Just s<font color=Cyan>)</font> <font color=Red>=</font> Just <font color=Cyan>$</font> IS.insert g s
<a name="line-192"></a>    aux g m <font color=Cyan>(</font>NoOp<font color=Red><b>:</b></font><font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> error <font color=Magenta>"circuitControlWires cannot deal with NoOp"</font>
<a name="line-193"></a>
<a name="line-194"></a><a name="circuitNotWires"></a><font color=Blue><i>-- | For each wire, find the set of gates acting on it with NOT.</i></font>
<a name="line-195"></a><font color=Blue>circuitNotWires</font> <font color=Red>::</font> GateId <font color=Red>-&gt;</font> <font color=Red>[</font>Gate<font color=Red>]</font> <font color=Red>-&gt;</font> UsedWire
<a name="line-196"></a><font color=Blue>circuitNotWires</font> id gs <font color=Red>=</font> aux id IM.empty gs
<a name="line-197"></a>  <font color=Green><u>where</u></font>
<a name="line-198"></a>    aux <font color=Green><u>_</u></font> m [] <font color=Red>=</font> m
<a name="line-199"></a>    aux g m <font color=Cyan>(</font>Init <font color=Green><u>_</u></font> <font color=Green><u>_</u></font><font color=Red><b>:</b></font>gs<font color=Cyan>)</font> <font color=Red>=</font> aux <font color=Cyan>(</font>g<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> m gs
<a name="line-200"></a>    aux g m <font color=Cyan>(</font><font color=Cyan>(</font>Cnot w <font color=Green><u>_</u></font><font color=Cyan>)</font><font color=Red><b>:</b></font>gs<font color=Cyan>)</font> <font color=Red>=</font> aux <font color=Cyan>(</font>g<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> m' gs
<a name="line-201"></a>      <font color=Green><u>where</u></font>
<a name="line-202"></a>        m' <font color=Red>=</font> IM.alter <font color=Cyan>(</font>f g<font color=Cyan>)</font> w m
<a name="line-203"></a>        f g Nothing <font color=Red>=</font> Just <font color=Cyan>$</font> IS.singleton g
<a name="line-204"></a>        f g <font color=Cyan>(</font>Just s<font color=Cyan>)</font> <font color=Red>=</font> Just <font color=Cyan>$</font> IS.insert g s
<a name="line-205"></a>    aux g m <font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Red><b>:</b></font>gs<font color=Cyan>)</font> <font color=Red>=</font> aux <font color=Cyan>(</font>g<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> m gs
<a name="line-206"></a>
<a name="line-207"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-208"></a><font color=Blue><i>-- * Algebraic optimization method</i></font>
<a name="line-209"></a>
<a name="line-210"></a><font color=Blue><i>-- $ To each wire in a circuit, we attach a set of formulas.  At each</i></font>
<a name="line-211"></a><font color=Blue><i>-- iteration, the wire that gets modified is updated with its new</i></font>
<a name="line-212"></a><font color=Blue><i>-- value, using all the possible values, possibly together with a</i></font>
<a name="line-213"></a><font color=Blue><i>-- fresh variable.  At each iteration, we also strip away the</i></font>
<a name="line-214"></a><font color=Blue><i>-- expressions that get too large. Here, the size of an algebraic</i></font>
<a name="line-215"></a><font color=Blue><i>-- expression is measured by the 'exp_length' function.</i></font>
<a name="line-216"></a>
<a name="line-217"></a><a name="exp_length"></a><font color=Blue><i>-- | Calculate the size of an algebraic expression.</i></font>
<a name="line-218"></a><font color=Blue>exp_length</font> <font color=Red>::</font> Exp <font color=Red>-&gt;</font> Int
<a name="line-219"></a><font color=Blue>exp_length</font> e <font color=Red>=</font> L.foldl' <font color=Cyan>(</font><font color=Cyan>+</font><font color=Cyan>)</font> <font color=Magenta>0</font> <font color=Cyan>$</font> L.map <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> <font color=Green><u>let</u></font> y <font color=Red>=</font> IS.size x <font color=Green><u>in</u></font> seq y y<font color=Cyan>)</font> <font color=Cyan>$</font> S.toList e
<a name="line-220"></a>
<a name="line-221"></a><a name="exp_list_and"></a><font color=Blue><i>-- | Given a list of sets of expressions, form the conjunction of</i></font>
<a name="line-222"></a><font color=Blue><i>-- every possible choice of one expression from each set. For example.</i></font>
<a name="line-223"></a><font color=Blue><i>-- </i></font>
<a name="line-224"></a><font color=Blue><i>-- &gt; exp_list_and [{a,b}, {c,d}, {e,f}] = </i></font>
<a name="line-225"></a><font color=Blue><i>-- &gt;     [a&#8743;c&#8743;e, a&#8743;c&#8743;f, a&#8743;d&#8743;e, a&#8743;d&#8743;f, b&#8743;c&#8743;e, b&#8743;c&#8743;f, b&#8743;d&#8743;e, b&#8743;d&#8743;f].</i></font>
<a name="line-226"></a><font color=Blue>exp_list_and</font> <font color=Red>::</font> <font color=Red>[</font>S.Set Exp<font color=Red>]</font> <font color=Red>-&gt;</font> S.Set Exp
<a name="line-227"></a><font color=Blue>exp_list_and</font> []  <font color=Red>=</font> S.singleton exp_true
<a name="line-228"></a><font color=Blue>exp_list_and</font> <font color=Red>[</font>l<font color=Red>]</font> <font color=Red>=</font> l
<a name="line-229"></a><font color=Blue>exp_list_and</font> <font color=Cyan>(</font>h<font color=Red><b>:</b></font>k<font color=Red><b>:</b></font>t<font color=Cyan>)</font> <font color=Red>=</font> exp_list_and <font color=Cyan>(</font>S.fromList <font color=Red>[</font>exp_and x y <font color=Red>|</font> x <font color=Red>&lt;-</font> S.toList h<font color=Cyan>,</font> y <font color=Red>&lt;-</font> S.toList k<font color=Red>]</font><font color=Red><b>:</b></font>t<font color=Cyan>)</font>
<a name="line-230"></a>
<a name="line-231"></a><a name="expEvalCtl"></a><font color=Blue><i>-- | Evaluate a control with respect to a state.</i></font>
<a name="line-232"></a><font color=Blue>expEvalCtl</font> <font color=Red>::</font> <font color=Cyan>(</font>IM.IntMap <font color=Cyan>(</font>S.Set <font color=Cyan>(</font>Exp<font color=Cyan>,</font>Int<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>Wire<font color=Cyan>,</font>Bool<font color=Cyan>)</font> <font color=Red>-&gt;</font> S.Set Exp
<a name="line-233"></a><font color=Blue>expEvalCtl</font> m <font color=Cyan>(</font>w<font color=Cyan>,</font>True<font color=Cyan>)</font>  <font color=Red>=</font> S.map fst <font color=Cyan>(</font>m IM<font color=Cyan>.!</font> w<font color=Cyan>)</font>
<a name="line-234"></a><font color=Blue>expEvalCtl</font> m <font color=Cyan>(</font>w<font color=Cyan>,</font>False<font color=Cyan>)</font> <font color=Red>=</font> S.map exp_not <font color=Cyan>$</font> S.map fst <font color=Cyan>$</font> <font color=Cyan>(</font>IM<font color=Cyan>.!</font><font color=Cyan>)</font> m w
<a name="line-235"></a>
<a name="line-236"></a><a name="expEvalGate"></a><font color=Blue><i>-- | Evaluate a gate with respect to a state.</i></font>
<a name="line-237"></a><font color=Blue>expEvalGate</font> <font color=Red>::</font> <font color=Cyan>(</font>IM.IntMap <font color=Cyan>(</font>S.Set <font color=Cyan>(</font>Exp<font color=Cyan>,</font>Int<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> Gate <font color=Red>-&gt;</font> IM.IntMap <font color=Cyan>(</font>S.Set <font color=Cyan>(</font>Exp<font color=Cyan>,</font>Int<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-238"></a>
<a name="line-239"></a><font color=Blue>expEvalGate</font> m <font color=Cyan>(</font>Init False w<font color=Cyan>)</font> <font color=Red>=</font> IM.insert w <font color=Cyan>(</font>S.singleton <font color=Cyan>(</font>exp_false<font color=Cyan>,</font><font color=Magenta>0</font><font color=Cyan>)</font><font color=Cyan>)</font> m
<a name="line-240"></a><font color=Blue>expEvalGate</font> m <font color=Cyan>(</font>Init True  w<font color=Cyan>)</font> <font color=Red>=</font> IM.insert w <font color=Cyan>(</font>S.singleton <font color=Cyan>(</font>exp_true<font color=Cyan>,</font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> m
<a name="line-241"></a><font color=Blue>expEvalGate</font> m NoOp <font color=Red>=</font> m
<a name="line-242"></a>
<a name="line-243"></a><font color=Blue>expEvalGate</font> m <font color=Cyan>(</font>Cnot w ctls<font color=Cyan>)</font> <font color=Red>=</font> IM.insert w cnot m
<a name="line-244"></a>  <font color=Green><u>where</u></font>
<a name="line-245"></a>    ands <font color=Red>=</font> exp_list_and <font color=Cyan>$</font> L.map <font color=Cyan>(</font>expEvalCtl m<font color=Cyan>)</font> ctls
<a name="line-246"></a>    cnot <font color=Red>=</font> S.map <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>exp_length x<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>S.fromList <font color=Red>[</font>exp_xor x y <font color=Red>|</font>
<a name="line-247"></a>                                              x <font color=Red>&lt;-</font> S.toList <font color=Cyan>$</font> S.map fst <font color=Cyan>$</font> <font color=Cyan>(</font>IM<font color=Cyan>.!</font><font color=Cyan>)</font> m w<font color=Cyan>,</font>
<a name="line-248"></a>                                              y <font color=Red>&lt;-</font> S.toList ands <font color=Red>]</font><font color=Cyan>)</font>
<a name="line-249"></a>
<a name="line-250"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-251"></a><font color=Blue><i>-- ** State of the optimization automaton</i></font>
<a name="line-252"></a>
<a name="line-253"></a><a name="ExpState"></a><font color=Blue><i>-- | The state of the automaton. This contains in particular the</i></font>
<a name="line-254"></a><a name="ExpState"></a><font color=Blue><i>-- current state, the past and future gates, and a fresh variable.</i></font>
<a name="line-255"></a><a name="ExpState"></a><font color=Green><u>data</u></font> ExpState <font color=Red>=</font> ExpState <font color=Cyan>{</font>
<a name="line-256"></a>  gates_to_skip <font color=Red>::</font> IM.IntMap Gate<font color=Cyan>,</font> <font color=Blue><i>-- ^ For use with 'stepSwapCirc'.</i></font>
<a name="line-257"></a>  allWiresInCirc <font color=Red>::</font> IS.IntSet<font color=Cyan>,</font>     <font color=Blue><i>-- ^ All the wires in the circuit.</i></font>
<a name="line-258"></a>  gateId <font color=Red>::</font> GateId<font color=Cyan>,</font>                <font color=Blue><i>-- ^ ID of the first gate in the future (starts at 1).</i></font>
<a name="line-259"></a>  usedControlWires <font color=Red>::</font> UsedWire<font color=Cyan>,</font>    <font color=Blue><i>-- ^ Location of the controls.</i></font>
<a name="line-260"></a>  usedNotWires <font color=Red>::</font> UsedWire<font color=Cyan>,</font>        <font color=Blue><i>-- ^ Location of the NOT gates.</i></font>
<a name="line-261"></a>  future <font color=Red>::</font> <font color=Red>[</font>Gate<font color=Red>]</font><font color=Cyan>,</font>                <font color=Blue><i>-- ^ Gates left to explore.</i></font>
<a name="line-262"></a>  past <font color=Red>::</font> <font color=Red>[</font>Gate<font color=Red>]</font><font color=Cyan>,</font>                  <font color=Blue><i>-- ^ Gates already explored.</i></font>
<a name="line-263"></a>  expMap <font color=Red>::</font> IM.IntMap <font color=Cyan>(</font>S.Set <font color=Cyan>(</font>Exp<font color=Cyan>,</font>Int<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Blue><i>-- ^ Algebraic state of the wires. Also contains the size of the expression, so we don't have to recompute it each time.</i></font>
<a name="line-264"></a>  freshVar <font color=Red>::</font> Integer<font color=Cyan>,</font>             <font color=Blue><i>-- ^ The next fresh wire.</i></font>
<a name="line-265"></a>  outWires <font color=Red>::</font> <font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>,</font>              <font color=Blue><i>-- ^ The output wires.</i></font>
<a name="line-266"></a>  sizeCirc <font color=Red>::</font> Int                  <font color=Blue><i>-- ^ Size of the circuit.</i></font>
<a name="line-267"></a>  <font color=Cyan>}</font>
<a name="line-268"></a>
<a name="line-269"></a>
<a name="line-270"></a><a name="instance%20Seq.NFData%20Gate"></a><font color=Green><u>instance</u></font> Seq.NFData Gate <font color=Green><u>where</u></font>
<a name="line-271"></a>    rnf <font color=Cyan>(</font>Init a b<font color=Cyan>)</font> <font color=Red>=</font> a <font color=Cyan>`seq`</font> b <font color=Cyan>`seq`</font> ()
<a name="line-272"></a>    rnf <font color=Cyan>(</font>Cnot w ctls<font color=Cyan>)</font> <font color=Red>=</font> ctls <font color=Cyan>`Seq.deepseq`</font> w <font color=Cyan>`Seq.deepseq`</font> ()
<a name="line-273"></a>    rnf NoOp <font color=Red>=</font> ()
<a name="line-274"></a>
<a name="line-275"></a><font color=Blue><i>{-
<a name="line-276"></a>instance Seq.NFData ExpState where
<a name="line-277"></a>    rnf e = {-allWiresInCirc e `Seq.deepseq` gateId e `Seq.deepseq` usedControlWires e `Seq.deepseq` usedNotWires e `Seq.deepseq` future e `Seq.deepseq` past e `Seq.deepseq` expMap e `Seq.deepseq` freshVar e `Seq.deepseq` outWires e-} () `Seq.deepseq` ()
<a name="line-278"></a>-}</i></font>
<a name="line-279"></a>
<a name="line-280"></a><a name="initExpState"></a><font color=Blue><i>-- | The initial state for a given set of parameters.</i></font>
<a name="line-281"></a><font color=Blue>initExpState</font> <font color=Red>::</font> IS.IntSet <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Gate<font color=Red>]</font> <font color=Red>-&gt;</font> ExpState
<a name="line-282"></a><font color=Blue>initExpState</font> ws_in ws_out gs <font color=Red>=</font> ExpState <font color=Cyan>{</font>
<a name="line-283"></a>  gates_to_skip <font color=Red>=</font> IM.empty<font color=Cyan>,</font>
<a name="line-284"></a>  allWiresInCirc <font color=Red>=</font> getAllWires gs<font color=Cyan>,</font>
<a name="line-285"></a>  gateId <font color=Red>=</font> <font color=Magenta>1</font><font color=Cyan>,</font>
<a name="line-286"></a>  usedControlWires <font color=Red>=</font> circuitControlWires <font color=Magenta>1</font> gs<font color=Cyan>,</font>
<a name="line-287"></a>  usedNotWires <font color=Red>=</font> circuitNotWires <font color=Magenta>1</font> gs<font color=Cyan>,</font>
<a name="line-288"></a>  future <font color=Red>=</font> gs<font color=Cyan>,</font>
<a name="line-289"></a>  past <font color=Red>=</font> []<font color=Cyan>,</font>
<a name="line-290"></a>  expMap   <font color=Red>=</font> IM.fromList <font color=Cyan>$</font> L.map <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> <font color=Cyan>(</font>x<font color=Cyan>,</font> S.singleton <font color=Cyan>(</font>exp_var x<font color=Cyan>,</font> <font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> IS.toAscList ws_in<font color=Cyan>,</font>
<a name="line-291"></a>  freshVar <font color=Red>=</font> fromIntegral <font color=Cyan>$</font> <font color=Cyan>(</font><font color=Cyan>+</font><font color=Cyan>)</font> <font color=Magenta>1</font> <font color=Cyan>$</font> IS.findMax ws_in<font color=Cyan>,</font>
<a name="line-292"></a>  outWires <font color=Red>=</font> ws_out<font color=Cyan>,</font>
<a name="line-293"></a>  sizeCirc <font color=Red>=</font> length gs
<a name="line-294"></a>  <font color=Cyan>}</font>
<a name="line-295"></a>
<a name="line-296"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-297"></a><font color=Blue><i>-- ** The state monad</i></font>
<a name="line-298"></a>
<a name="line-299"></a><a name="EvalCirc"></a><font color=Blue><i>-- | The state monad corresponding to 'ExpState'.</i></font>
<a name="line-300"></a><a name="EvalCirc"></a><font color=Green><u>data</u></font> EvalCirc a <font color=Red>=</font>  EvalCirc <font color=Cyan>(</font>ExpState <font color=Red>-&gt;</font> <font color=Cyan>(</font>ExpState<font color=Cyan>,</font> a<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-301"></a>
<a name="line-302"></a><a name="instance%20Monad%20EvalCirc"></a><font color=Green><u>instance</u></font> Monad EvalCirc <font color=Green><u>where</u></font>
<a name="line-303"></a>  return x <font color=Red>=</font> EvalCirc <font color=Cyan>(</font><font color=Red>\</font>y <font color=Red>-&gt;</font> <font color=Cyan>(</font>y<font color=Cyan>,</font>x<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-304"></a>  <font color=Cyan>(</font><font color=Cyan>&gt;&gt;=</font><font color=Cyan>)</font> <font color=Cyan>(</font>EvalCirc c<font color=Cyan>)</font> f <font color=Red>=</font> EvalCirc <font color=Cyan>(</font><font color=Red>\</font>s <font color=Red>-&gt;</font> <font color=Green><u>let</u></font> <font color=Cyan>(</font>s'<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Red>=</font> c s <font color=Green><u>in</u></font>
<a name="line-305"></a>                                 <font color=Green><u>let</u></font> <font color=Cyan>(</font>EvalCirc c'<font color=Cyan>)</font> <font color=Red>=</font> f x <font color=Green><u>in</u></font>
<a name="line-306"></a>                                 c' s'<font color=Cyan>)</font>
<a name="line-307"></a>
<a name="line-308"></a><a name="instance%20Applicative%20EvalCirc"></a><font color=Green><u>instance</u></font> Applicative EvalCirc <font color=Green><u>where</u></font>
<a name="line-309"></a>  pure <font color=Red>=</font> return
<a name="line-310"></a>  <font color=Cyan>(</font><font color=Cyan>&lt;*&gt;</font><font color=Cyan>)</font> <font color=Red>=</font> ap
<a name="line-311"></a>
<a name="line-312"></a><a name="instance%20Functor%20EvalCirc"></a><font color=Green><u>instance</u></font> Functor EvalCirc <font color=Green><u>where</u></font>
<a name="line-313"></a>  fmap <font color=Red>=</font> liftM
<a name="line-314"></a>
<a name="line-315"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-316"></a><font color=Blue><i>-- ** Low-level access functions</i></font>
<a name="line-317"></a>
<a name="line-318"></a><a name="runEvalCirc"></a><font color=Blue><i>-- | Construct an @'ExpState'@ out of an @'EvalCirc'@.</i></font>
<a name="line-319"></a><font color=Blue>runEvalCirc</font> <font color=Red>::</font> IS.IntSet <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Gate<font color=Red>]</font> <font color=Red>-&gt;</font> EvalCirc a <font color=Red>-&gt;</font> ExpState
<a name="line-320"></a><font color=Blue>runEvalCirc</font> ws_in ws_out gs <font color=Cyan>(</font>EvalCirc e<font color=Cyan>)</font> <font color=Red>=</font> fst <font color=Cyan>$</font> e <font color=Cyan>$</font> initExpState ws_in ws_out gs
<a name="line-321"></a>
<a name="line-322"></a><a name="getExpState"></a><font color=Blue><i>-- | Retrieve the state.</i></font>
<a name="line-323"></a><font color=Blue>getExpState</font> <font color=Red>::</font> EvalCirc ExpState
<a name="line-324"></a><font color=Blue>getExpState</font> <font color=Red>=</font> EvalCirc <font color=Cyan>(</font><font color=Red>\</font>s <font color=Red>-&gt;</font> <font color=Cyan>(</font>s<font color=Cyan>,</font>s<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-325"></a>
<a name="line-326"></a><a name="setExpState"></a><font color=Blue><i>-- | Set the state.</i></font>
<a name="line-327"></a><font color=Blue>setExpState</font> <font color=Red>::</font> ExpState <font color=Red>-&gt;</font> EvalCirc ()
<a name="line-328"></a><font color=Blue>setExpState</font> s <font color=Red>=</font> EvalCirc <font color=Cyan>(</font><font color=Red>\</font><font color=Green><u>_</u></font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>s<font color=Cyan>,</font>()<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-329"></a>
<a name="line-330"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-331"></a><font color=Blue><i>-- ** Higher-level access functions</i></font>
<a name="line-332"></a>
<a name="line-333"></a><a name="newFreshVar"></a><font color=Blue><i>-- | Create a fresh variable</i></font>
<a name="line-334"></a><font color=Blue>newFreshVar</font> <font color=Red>::</font> EvalCirc Integer
<a name="line-335"></a><font color=Blue>newFreshVar</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-336"></a>  s <font color=Red>&lt;-</font> getExpState
<a name="line-337"></a>  <font color=Green><u>let</u></font> v <font color=Red>=</font> freshVar s
<a name="line-338"></a>  setExpState <font color=Cyan>(</font>s <font color=Cyan>{</font> freshVar <font color=Red>=</font> v <font color=Cyan>+</font> <font color=Magenta>1</font> <font color=Cyan>}</font><font color=Cyan>)</font> 
<a name="line-339"></a>  return v
<a name="line-340"></a>
<a name="line-341"></a><a name="pullNewGate"></a><font color=Blue><i>-- | Pull a new gate to be analyzed out of the future.</i></font>
<a name="line-342"></a><font color=Blue>pullNewGate</font> <font color=Red>::</font> EvalCirc <font color=Cyan>(</font>Maybe Gate<font color=Cyan>)</font>
<a name="line-343"></a><font color=Blue>pullNewGate</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-344"></a>  s <font color=Red>&lt;-</font> getExpState
<a name="line-345"></a>  <font color=Green><u>case</u></font> <font color=Cyan>(</font>future s<font color=Cyan>)</font> <font color=Green><u>of</u></font>
<a name="line-346"></a>    <font color=Cyan>(</font>h<font color=Red><b>:</b></font>t<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> setExpState <font color=Cyan>(</font>s <font color=Cyan>{</font> future <font color=Red>=</font> t <font color=Cyan>}</font> <font color=Cyan>)</font>
<a name="line-347"></a>                return <font color=Cyan>(</font>Just h<font color=Cyan>)</font>
<a name="line-348"></a>    []    <font color=Red>-&gt;</font> return Nothing
<a name="line-349"></a>
<a name="line-350"></a><a name="changeFuture"></a><font color=Blue><i>-- | Modify the future gates.</i></font>
<a name="line-351"></a><font color=Blue>changeFuture</font> <font color=Red>::</font> <font color=Red>[</font>Gate<font color=Red>]</font> <font color=Red>-&gt;</font> EvalCirc ()
<a name="line-352"></a><font color=Blue>changeFuture</font> gs <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-353"></a>  s <font color=Red>&lt;-</font> getExpState
<a name="line-354"></a>  setExpState <font color=Cyan>(</font>s <font color=Cyan>{</font> future <font color=Red>=</font> gs <font color=Cyan>}</font> <font color=Cyan>)</font>
<a name="line-355"></a>  return ()
<a name="line-356"></a>
<a name="line-357"></a><a name="updateFuture"></a><font color=Blue><i>-- | Update the future using the given parameter function. Return two sets</i></font>
<a name="line-358"></a><font color=Blue><i>-- of 'gateId's that got modified: the first set concerns the controls,</i></font>
<a name="line-359"></a><font color=Blue><i>-- the second set the NOT gates.</i></font>
<a name="line-360"></a><font color=Blue>updateFuture</font> <font color=Red>::</font> <font color=Cyan>(</font>Gate <font color=Red>-&gt;</font> Gate<font color=Cyan>)</font> <font color=Red>-&gt;</font> EvalCirc <font color=Cyan>(</font>IS.IntSet<font color=Cyan>,</font>IS.IntSet<font color=Cyan>)</font>
<a name="line-361"></a><font color=Blue>updateFuture</font> f <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-362"></a>  s <font color=Red>&lt;-</font> getExpState
<a name="line-363"></a>  <font color=Green><u>let</u></font> <font color=Cyan>(</font><font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Cyan>,</font><font color=Cyan>!</font>gsModifCtls<font color=Cyan>,</font><font color=Cyan>!</font>gsModifNots<font color=Cyan>)</font><font color=Cyan>,</font>new_future<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-364"></a>              L.mapAccumL <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>gid<font color=Cyan>,</font>gs<font color=Cyan>,</font>gs'<font color=Cyan>)</font> g <font color=Red>-&gt;</font> <font color=Green><u>let</u></font> g' <font color=Red>=</font> f g <font color=Green><u>in</u></font>
<a name="line-365"></a>                                        <font color=Cyan>(</font><font color=Cyan>(</font>
<a name="line-366"></a>                                        gid<font color=Cyan>+</font><font color=Magenta>1</font>
<a name="line-367"></a>                                        <font color=Cyan>,</font>
<a name="line-368"></a>                                        <font color=Green><u>if</u></font> <font color=Cyan>(</font>ctlsOfGate g <font color=Cyan>==</font> ctlsOfGate g'<font color=Cyan>)</font> 
<a name="line-369"></a>                                        <font color=Green><u>then</u></font> gs
<a name="line-370"></a>                                        <font color=Green><u>else</u></font> IS.insert gid gs
<a name="line-371"></a>                                        <font color=Cyan>,</font>
<a name="line-372"></a>                                        <font color=Green><u>if</u></font> <font color=Cyan>(</font>wireOfGate g <font color=Cyan>==</font> wireOfGate g'<font color=Cyan>)</font> 
<a name="line-373"></a>                                        <font color=Green><u>then</u></font> gs'
<a name="line-374"></a>                                        <font color=Green><u>else</u></font> IS.insert gid gs'
<a name="line-375"></a>                                        <font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-376"></a>                                        g'<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-377"></a>                        <font color=Cyan>(</font><font color=Magenta>1</font> <font color=Cyan>+</font> <font color=Cyan>(</font>gateId s<font color=Cyan>)</font><font color=Cyan>,</font> IS.empty<font color=Cyan>,</font>IS.empty<font color=Cyan>)</font> <font color=Cyan>(</font>future s<font color=Cyan>)</font>
<a name="line-378"></a>  changeFuture new_future
<a name="line-379"></a>  
<a name="line-380"></a>  return <font color=Cyan>(</font>gsModifCtls<font color=Cyan>,</font>gsModifNots<font color=Cyan>)</font>
<a name="line-381"></a>
<a name="line-382"></a><a name="storeOldGate"></a><font color=Blue><i>-- | Store a gate in the past.</i></font>
<a name="line-383"></a><font color=Blue>storeOldGate</font> <font color=Red>::</font> Gate <font color=Red>-&gt;</font> EvalCirc ()
<a name="line-384"></a><font color=Blue>storeOldGate</font> g <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-385"></a>  s <font color=Red>&lt;-</font> getExpState
<a name="line-386"></a>  <font color=Green><u>let</u></font> p <font color=Red>=</font> past s
<a name="line-387"></a>  seq g <font color=Cyan>$</font> seq p <font color=Cyan>$</font> setExpState <font color=Cyan>(</font>s <font color=Cyan>{</font> past <font color=Red>=</font> g<font color=Red><b>:</b></font>p <font color=Cyan>}</font> <font color=Cyan>)</font>
<a name="line-388"></a>  return ()
<a name="line-389"></a>
<a name="line-390"></a><a name="incrGateId"></a><font color=Blue><i>-- | Increase the '@gateId@' (i.e., go forward).</i></font>
<a name="line-391"></a><font color=Blue>incrGateId</font> <font color=Red>::</font> EvalCirc ()
<a name="line-392"></a><font color=Blue>incrGateId</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-393"></a>  s <font color=Red>&lt;-</font> getExpState
<a name="line-394"></a>  setExpState <font color=Cyan>(</font>s <font color=Cyan>{</font> gateId <font color=Red>=</font> <font color=Magenta>1</font> <font color=Cyan>+</font> <font color=Cyan>(</font>gateId s<font color=Cyan>)</font> <font color=Cyan>}</font> <font color=Cyan>)</font>
<a name="line-395"></a>  return ()
<a name="line-396"></a>
<a name="line-397"></a><a name="getAllWiresInCirc"></a><font color=Blue><i>-- | Get the set of all wires.</i></font>
<a name="line-398"></a><font color=Blue>getAllWiresInCirc</font> <font color=Red>::</font> EvalCirc IS.IntSet
<a name="line-399"></a><font color=Blue>getAllWiresInCirc</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-400"></a>  s <font color=Red>&lt;-</font> getExpState
<a name="line-401"></a>  return <font color=Cyan>(</font>allWiresInCirc s<font color=Cyan>)</font>
<a name="line-402"></a>
<a name="line-403"></a><a name="setAllWiresInCirc"></a><font color=Blue><i>-- | Set the set of all wires.</i></font>
<a name="line-404"></a><font color=Blue>setAllWiresInCirc</font> <font color=Red>::</font> IS.IntSet <font color=Red>-&gt;</font> EvalCirc ()
<a name="line-405"></a><font color=Blue>setAllWiresInCirc</font> ws <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-406"></a>  s <font color=Red>&lt;-</font> getExpState
<a name="line-407"></a>  ws <font color=Cyan>`seq`</font> setExpState <font color=Cyan>(</font>s <font color=Cyan>{</font>allWiresInCirc <font color=Red>=</font> ws<font color=Cyan>}</font><font color=Cyan>)</font>
<a name="line-408"></a>  return ()
<a name="line-409"></a>
<a name="line-410"></a><a name="removeFromAllWiresInCirc"></a><font color=Blue><i>-- | Remove a gate from the set of all wires.</i></font>
<a name="line-411"></a><font color=Blue>removeFromAllWiresInCirc</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> EvalCirc ()
<a name="line-412"></a><font color=Blue>removeFromAllWiresInCirc</font> w <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-413"></a>  ws <font color=Red>&lt;-</font> getAllWiresInCirc
<a name="line-414"></a>  setAllWiresInCirc <font color=Cyan>$</font> IS.delete w ws
<a name="line-415"></a>  return ()
<a name="line-416"></a>
<a name="line-417"></a><a name="getExpMap"></a><font color=Blue><i>-- | Get the algebraic representation of the set of wires.</i></font>
<a name="line-418"></a><font color=Blue>getExpMap</font> <font color=Red>::</font> EvalCirc <font color=Cyan>(</font>IM.IntMap <font color=Cyan>(</font>S.Set <font color=Cyan>(</font>Exp<font color=Cyan>,</font>Int<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-419"></a><font color=Blue>getExpMap</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-420"></a>  s <font color=Red>&lt;-</font> getExpState
<a name="line-421"></a>  s <font color=Cyan>`seq`</font> return <font color=Cyan>(</font>expMap s<font color=Cyan>)</font>
<a name="line-422"></a>
<a name="line-423"></a><a name="setExpMap"></a><font color=Blue><i>-- | Set the algebraic representation of the state of wires.</i></font>
<a name="line-424"></a><font color=Blue>setExpMap</font> <font color=Red>::</font> <font color=Cyan>(</font>IM.IntMap <font color=Cyan>(</font>S.Set <font color=Cyan>(</font>Exp<font color=Cyan>,</font>Int<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> EvalCirc ()
<a name="line-425"></a><font color=Blue>setExpMap</font> m <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-426"></a>  s <font color=Red>&lt;-</font> getExpState
<a name="line-427"></a>  m <font color=Cyan>`seq`</font> setExpState <font color=Cyan>(</font>s <font color=Cyan>{</font> expMap <font color=Red>=</font> m <font color=Cyan>}</font> <font color=Cyan>)</font>
<a name="line-428"></a>  return ()
<a name="line-429"></a>
<a name="line-430"></a><a name="updateUsedControlWires"></a><font color=Blue><i>-- | Update the database recording the controlled wires.</i></font>
<a name="line-431"></a><font color=Blue>updateUsedControlWires</font> <font color=Red>::</font> <font color=Cyan>(</font>UsedWire <font color=Red>-&gt;</font> UsedWire<font color=Cyan>)</font> <font color=Red>-&gt;</font> EvalCirc ()
<a name="line-432"></a><font color=Blue>updateUsedControlWires</font> f <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-433"></a>  s <font color=Red>&lt;-</font> getExpState
<a name="line-434"></a>  <font color=Green><u>let</u></font> c <font color=Red>=</font> f <font color=Cyan>$</font> usedControlWires s
<a name="line-435"></a>  c <font color=Cyan>`seq`</font> setExpState <font color=Cyan>(</font>s <font color=Cyan>{</font> usedControlWires <font color=Red>=</font> c <font color=Cyan>}</font> <font color=Cyan>)</font>
<a name="line-436"></a>  return ()
<a name="line-437"></a>
<a name="line-438"></a><a name="updateUsedNotWires"></a><font color=Blue><i>-- | Update the database recording the NOT gates.</i></font>
<a name="line-439"></a><font color=Blue>updateUsedNotWires</font> <font color=Red>::</font> <font color=Cyan>(</font>UsedWire <font color=Red>-&gt;</font> UsedWire<font color=Cyan>)</font> <font color=Red>-&gt;</font> EvalCirc ()
<a name="line-440"></a><font color=Blue>updateUsedNotWires</font> f <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-441"></a>  s <font color=Red>&lt;-</font> getExpState
<a name="line-442"></a>  <font color=Green><u>let</u></font> c <font color=Red>=</font> f <font color=Cyan>$</font> usedNotWires s
<a name="line-443"></a>  c <font color=Cyan>`seq`</font> setExpState <font color=Cyan>(</font>s <font color=Cyan>{</font> usedNotWires <font color=Red>=</font> c <font color=Cyan>}</font> <font color=Cyan>)</font>
<a name="line-444"></a>  return ()
<a name="line-445"></a>
<a name="line-446"></a><a name="updateOutWires"></a><font color=Blue><i>-- | Update the list of output wires.</i></font>
<a name="line-447"></a><font color=Blue>updateOutWires</font> <font color=Red>::</font> <font color=Cyan>(</font><font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> EvalCirc ()
<a name="line-448"></a><font color=Blue>updateOutWires</font> f <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-449"></a>  s <font color=Red>&lt;-</font> getExpState
<a name="line-450"></a>  <font color=Green><u>let</u></font> c <font color=Red>=</font> f <font color=Cyan>$</font> outWires s
<a name="line-451"></a>  c <font color=Cyan>`seq`</font> setExpState <font color=Cyan>(</font>s <font color=Cyan>{</font> outWires <font color=Red>=</font> c <font color=Cyan>}</font> <font color=Cyan>)</font>
<a name="line-452"></a>  return ()
<a name="line-453"></a>
<a name="line-454"></a><a name="addToSkipGates"></a><font color=Blue><i>-- | Add a gate ID to the list of gates to skip.</i></font>
<a name="line-455"></a><font color=Blue>addToSkipGates</font> <font color=Red>::</font> GateId <font color=Red>-&gt;</font> Gate <font color=Red>-&gt;</font> EvalCirc ()
<a name="line-456"></a><font color=Blue>addToSkipGates</font> id g <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-457"></a>  s <font color=Red>&lt;-</font> getExpState
<a name="line-458"></a>  <font color=Green><u>let</u></font> c <font color=Red>=</font> IM.insert id g <font color=Cyan>(</font>gates_to_skip s<font color=Cyan>)</font>
<a name="line-459"></a>  c <font color=Cyan>`seq`</font> setExpState <font color=Cyan>(</font>s <font color=Cyan>{</font>gates_to_skip <font color=Red>=</font> c<font color=Cyan>}</font> <font color=Cyan>)</font>
<a name="line-460"></a>  return ()
<a name="line-461"></a>
<a name="line-462"></a><a name="sendEndOfTime"></a><font color=Blue><i>-- | Send a gate to the end of the future.</i></font>
<a name="line-463"></a><font color=Blue>sendEndOfTime</font> <font color=Red>::</font> Gate <font color=Red>-&gt;</font> EvalCirc ()
<a name="line-464"></a><font color=Blue>sendEndOfTime</font> g <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-465"></a>   s <font color=Red>&lt;-</font> getExpState
<a name="line-466"></a>   changeFuture <font color=Cyan>(</font><font color=Cyan>(</font>future s<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Red>[</font>g<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-467"></a>   return ()
<a name="line-468"></a>
<a name="line-469"></a><a name="shiftGate"></a><font color=Blue><i>-- | Place a gate at the given gate ID in the future.</i></font>
<a name="line-470"></a><font color=Blue>shiftGate</font> <font color=Red>::</font> Gate <font color=Red>-&gt;</font> GateId <font color=Red>-&gt;</font> EvalCirc ()
<a name="line-471"></a><font color=Blue>shiftGate</font> g x <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-472"></a>   s <font color=Red>&lt;-</font> getExpState
<a name="line-473"></a>   <font color=Green><u>let</u></font> <font color=Cyan>(</font><font color=Cyan>!</font>head<font color=Cyan>,</font> <font color=Cyan>!</font>tail<font color=Cyan>)</font> <font color=Red>=</font> splitAt x <font color=Cyan>(</font>future s<font color=Cyan>)</font>
<a name="line-474"></a>   <font color=Green><u>let</u></font> z <font color=Red>=</font> head <font color=Cyan>++</font> <font color=Red>[</font>g<font color=Red>]</font> <font color=Cyan>++</font> tail
<a name="line-475"></a>   z <font color=Cyan>`Seq.deepseq`</font> changeFuture z
<a name="line-476"></a>   return ()
<a name="line-477"></a>
<a name="line-478"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-479"></a><font color=Blue><i>-- ** Auxiliary functions</i></font>
<a name="line-480"></a>
<a name="line-481"></a><a name="pairEqualExp"></a><font color=Blue><i>-- | @pairEqualExp m1 m2 ws@: returns a list of pairs of wires @(x,y)@</i></font>
<a name="line-482"></a><font color=Blue><i>-- such that @m2 x = m1 x = m1 y@.</i></font>
<a name="line-483"></a><font color=Blue>pairEqualExp</font> <font color=Red>::</font> <font color=Cyan>(</font>IM.IntMap <font color=Red>[</font>Exp<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>IM.IntMap <font color=Red>[</font>Exp<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font><font color=Cyan>(</font>Wire<font color=Cyan>,</font>Wire<font color=Cyan>)</font><font color=Red>]</font>
<a name="line-484"></a><font color=Blue>pairEqualExp</font> m1 m2 ws <font color=Red>=</font> 
<a name="line-485"></a>  L.map fst <font color=Cyan>$</font> L.filter aux <font color=Cyan>$</font> L.zip pair_ws <font color=Cyan>(</font>L.map value pair_ws<font color=Cyan>)</font>
<a name="line-486"></a>  <font color=Green><u>where</u></font>
<a name="line-487"></a>    all_pairs l <font color=Red>=</font> <font color=Red>[</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font> <font color=Red>|</font> x <font color=Red>&lt;-</font> l<font color=Cyan>,</font> y <font color=Red>&lt;-</font> l<font color=Red>]</font>
<a name="line-488"></a>    pair_ws <font color=Red>=</font> all_pairs ws
<a name="line-489"></a>    value <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>m2 IM<font color=Cyan>.!</font> x<font color=Cyan>,</font> m1 IM<font color=Cyan>.!</font> x<font color=Cyan>,</font> m1 IM<font color=Cyan>.!</font> y<font color=Cyan>)</font>
<a name="line-490"></a>    aux <font color=Cyan>(</font><font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>)</font><font color=Cyan>,</font><font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>c<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>=</font> a <font color=Cyan>==</font> b <font color=Cyan>&amp;&amp;</font> b <font color=Cyan>==</font> c
<a name="line-491"></a>
<a name="line-492"></a><a name="pruneListExp"></a><font color=Blue><i>-- | From a set of expressions (annotated with sizes), prune the ones</i></font>
<a name="line-493"></a><font color=Blue><i>-- whose size is larger than /n/.</i></font>
<a name="line-494"></a><font color=Blue>pruneListExp</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> S.Set <font color=Cyan>(</font>Exp<font color=Cyan>,</font>Int<font color=Cyan>)</font> <font color=Red>-&gt;</font> S.Set <font color=Cyan>(</font>Exp<font color=Cyan>,</font>Int<font color=Cyan>)</font>
<a name="line-495"></a><font color=Blue>pruneListExp</font> n l <font color=Red>=</font> S.filter <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> snd x <font color=Cyan>&lt;=</font> n<font color=Cyan>)</font> l
<a name="line-496"></a>
<a name="line-497"></a>
<a name="line-498"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-499"></a><font color=Blue><i>-- ** The algebraic optimization automaton          </i></font>
<a name="line-500"></a> 
<a name="line-501"></a><a name="stepEvalCirc"></a><font color=Blue><i>-- | Perform a set of filters acting on one gate at a time, looking</i></font>
<a name="line-502"></a><font color=Blue><i>-- for:</i></font>
<a name="line-503"></a><font color=Blue><i>-- </i></font>
<a name="line-504"></a><font color=Blue><i>--     * gates having no effect;</i></font>
<a name="line-505"></a><font color=Blue><i>--</i></font>
<a name="line-506"></a><font color=Blue><i>--     * orphan NOT-gates (i.e. NOT gates negating an out-wire) ;</i></font>
<a name="line-507"></a><font color=Blue><i>-- </i></font>
<a name="line-508"></a><font color=Blue><i>--     * simple copy-cats (both positive and negative) ;</i></font>
<a name="line-509"></a><font color=Blue><i>--</i></font>
<a name="line-510"></a><font color=Blue><i>--     * hidden copy-cats.</i></font>
<a name="line-511"></a><font color=Blue><i>--</i></font>
<a name="line-512"></a><font color=Blue><i>-- Return 'False' when the end of the circuit is reached, 'True' otherwise. </i></font>
<a name="line-513"></a><font color=Blue>stepEvalCirc</font> <font color=Red>::</font> EvalCirc Bool
<a name="line-514"></a><font color=Blue>stepEvalCirc</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-515"></a>  m_before <font color=Red>&lt;-</font> getExpMap
<a name="line-516"></a>  trace <font color=Cyan>(</font><font color=Magenta>"the state of the system is "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show <font color=Cyan>$</font> m_before<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-517"></a>  s <font color=Red>&lt;-</font> getExpState
<a name="line-518"></a>  <font color=Green><u>if</u></font> <font color=Cyan>(</font><font color=Cyan>(</font>gateId s<font color=Cyan>)</font> <font color=Cyan>`mod`</font> <font color=Magenta>1000</font> <font color=Cyan>==</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Green><u>then</u></font> trace <font color=Cyan>(</font><font color=Magenta>"Timestamp... "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show <font color=Cyan>(</font>gateId s<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>return ()<font color=Cyan>)</font> <font color=Green><u>else</u></font> return ()
<a name="line-519"></a>  s <font color=Red>&lt;-</font> getExpState
<a name="line-520"></a>  trace <font color=Cyan>(</font><font color=Magenta>"outside wires "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show <font color=Cyan>$</font> outWires s<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-521"></a>  maybe_g <font color=Red>&lt;-</font> pullNewGate
<a name="line-522"></a>  trace <font color=Cyan>(</font><font color=Magenta>"pulled new gate "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show maybe_g<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-523"></a>  s <font color=Red>&lt;-</font> getExpState
<a name="line-524"></a>  <font color=Green><u>case</u></font> maybe_g <font color=Green><u>of</u></font>
<a name="line-525"></a>
<a name="line-526"></a>    Nothing <font color=Red>-&gt;</font> return False
<a name="line-527"></a>      
<a name="line-528"></a>    Just g <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> <font color=Blue><i>-- analyze the gate</i></font>
<a name="line-529"></a>      m_before <font color=Red>&lt;-</font> getExpMap
<a name="line-530"></a>      <font color=Green><u>let</u></font> m_after <font color=Red>=</font> expEvalGate m_before g
<a name="line-531"></a>      
<a name="line-532"></a>      <font color=Green><u>case</u></font> g <font color=Green><u>of</u></font>
<a name="line-533"></a>        
<a name="line-534"></a>        NoOp <font color=Red>-&gt;</font> error <font color=Magenta>"stepEvalCirc cannot deal with NoOp"</font>
<a name="line-535"></a>        
<a name="line-536"></a>        Init b w <font color=Red>|</font> not <font color=Cyan>(</font><font color=Cyan>(</font>IM.member w <font color=Cyan>$</font> usedNotWires s<font color=Cyan>)</font> <font color=Cyan>||</font> <font color=Cyan>(</font>IM.member w <font color=Cyan>$</font> usedControlWires s<font color=Cyan>)</font> <font color=Cyan>||</font> L.elem w <font color=Cyan>(</font>outWires s<font color=Cyan>)</font><font color=Cyan>)</font><font color=Red>-&gt;</font> <font color=Green><u>do</u></font> 
<a name="line-537"></a>          trace <font color=Magenta>"got an orphan init, removing it"</font> <font color=Cyan>$</font> return ()
<a name="line-538"></a>          storeOldGate NoOp <font color=Blue><i>-- store a placeholder for the gate</i></font>
<a name="line-539"></a>          incrGateId
<a name="line-540"></a>          removeFromAllWiresInCirc w
<a name="line-541"></a>          <font color=Blue><i>-- we could also clean expMap from the reference to w but I think it makes no gain</i></font>
<a name="line-542"></a>          return True
<a name="line-543"></a>        
<a name="line-544"></a>        Init <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-545"></a>          trace <font color=Magenta>"got a regular init"</font> <font color=Cyan>$</font> return ()
<a name="line-546"></a>          storeOldGate g
<a name="line-547"></a>          setExpMap m_after
<a name="line-548"></a>          incrGateId
<a name="line-549"></a>          return True
<a name="line-550"></a>        
<a name="line-551"></a>        Cnot w <font color=Green><u>_</u></font> <font color=Red>|</font> not <font color=Cyan>$</font> S.null <font color=Cyan>$</font> S.intersection <font color=Cyan>(</font>m_before IM<font color=Cyan>.!</font> w<font color=Cyan>)</font> <font color=Cyan>(</font>m_after IM<font color=Cyan>.!</font> w<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-552"></a>          trace <font color=Magenta>"got a cnot where no change happened..."</font> <font color=Cyan>$</font> return ()
<a name="line-553"></a>          trace <font color=Cyan>(</font>show m_before<font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-554"></a>          trace <font color=Cyan>(</font>show m_after<font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-555"></a>          storeOldGate NoOp
<a name="line-556"></a>          incrGateId
<a name="line-557"></a>          return True
<a name="line-558"></a>
<a name="line-559"></a>        Cnot w [] <font color=Red>|</font> not <font color=Cyan>(</font>L.elem w <font color=Cyan>$</font> outWires s<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-560"></a>          trace <font color=Magenta>"got a not-gate that can be removed..."</font> <font color=Cyan>$</font> return ()
<a name="line-561"></a>          s <font color=Red>&lt;-</font> getExpState
<a name="line-562"></a>          <font color=Blue><i>-- update future</i></font>
<a name="line-563"></a>          changeFuture <font color=Cyan>$</font> L.map <font color=Cyan>(</font>flipCtl w<font color=Cyan>)</font> <font color=Cyan>$</font> future s
<a name="line-564"></a>          s <font color=Red>&lt;-</font> getExpState
<a name="line-565"></a>          trace <font color=Cyan>(</font>show <font color=Cyan>$</font> future s<font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-566"></a>          storeOldGate NoOp
<a name="line-567"></a>          incrGateId
<a name="line-568"></a>          return True
<a name="line-569"></a>        
<a name="line-570"></a>        
<a name="line-571"></a>        Cnot w ctls <font color=Red>|</font> otherwise <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-572"></a>          trace <font color=Magenta>"got a general cnot"</font> <font color=Cyan>$</font> return ()
<a name="line-573"></a>          trace <font color=Cyan>(</font><font color=Magenta>"state after the gate is "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show m_after<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-574"></a>          
<a name="line-575"></a>          allWs <font color=Red>&lt;-</font> getAllWiresInCirc
<a name="line-576"></a>          s <font color=Red>&lt;-</font> getExpState
<a name="line-577"></a>          <font color=Green><u>let</u></font> my_elem x <font color=Red>=</font> not <font color=Cyan>(</font>L.elem x <font color=Cyan>$</font> outWires s<font color=Cyan>)</font>
<a name="line-578"></a>          <font color=Green><u>let</u></font> all_ws <font color=Red>=</font> IS.toAscList <font color=Cyan>$</font> IS.filter future_ctl <font color=Cyan>$</font>
<a name="line-579"></a>                       IS.filter <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> my_elem x<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Blue><i>-- not (L.elem x $ outWires s)) $</i></font>
<a name="line-580"></a>                       IS.filter <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> not <font color=Cyan>$</font> S.null <font color=Cyan>$</font> 
<a name="line-581"></a>                                         S.intersection <font color=Cyan>(</font>m_after IM<font color=Cyan>.!</font> x<font color=Cyan>)</font>
<a name="line-582"></a>                                                        <font color=Cyan>(</font>m_after IM<font color=Cyan>.!</font> w<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font>
<a name="line-583"></a>                       IS.filter <font color=Cyan>(</font>w <font color=Cyan>/=</font><font color=Cyan>)</font> allWs <font color=Blue><i>-- IS.fromList $ L.map fst ctls </i></font>
<a name="line-584"></a>                <font color=Green><u>where</u></font>
<a name="line-585"></a>                  future_ctl x <font color=Red>=</font> 
<a name="line-586"></a>                    <font color=Cyan>(</font>lastUsedWire <font color=Cyan>(</font>usedNotWires s<font color=Cyan>)</font> x<font color=Cyan>)</font> <font color=Cyan>&lt;=</font> gateId s
<a name="line-587"></a>                    <font color=Cyan>&amp;&amp;</font>
<a name="line-588"></a>                    <font color=Cyan>(</font>lastUsedWire <font color=Cyan>(</font>usedNotWires s<font color=Cyan>)</font> w<font color=Cyan>)</font> <font color=Cyan>&lt;=</font> gateId s
<a name="line-589"></a>
<a name="line-590"></a>          <font color=Green><u>let</u></font> all_ws_neg <font color=Red>=</font> IS.toAscList <font color=Cyan>$</font> IS.filter future_ctl <font color=Cyan>$</font>
<a name="line-591"></a>                       IS.filter <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> not <font color=Cyan>(</font>L.elem x <font color=Cyan>$</font> outWires s<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font>
<a name="line-592"></a>                       IS.filter <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> not <font color=Cyan>$</font> S.null <font color=Cyan>$</font> 
<a name="line-593"></a>                                         S.intersection <font color=Cyan>(</font>m_after IM<font color=Cyan>.!</font> x<font color=Cyan>)</font>
<a name="line-594"></a>                                                        <font color=Cyan>(</font>S.map <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>e<font color=Cyan>,</font>i<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>exp_not e<font color=Cyan>,</font> i<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>m_after IM<font color=Cyan>.!</font> w<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font>
<a name="line-595"></a>                       IS.filter <font color=Cyan>(</font>w <font color=Cyan>/=</font><font color=Cyan>)</font> <font color=Cyan>$</font> IS.fromList <font color=Cyan>$</font> L.map fst ctls
<a name="line-596"></a>                <font color=Green><u>where</u></font>
<a name="line-597"></a>                  future_ctl x <font color=Red>=</font> 
<a name="line-598"></a>                    <font color=Cyan>(</font>lastUsedWire <font color=Cyan>(</font>usedNotWires s<font color=Cyan>)</font> x<font color=Cyan>)</font> <font color=Cyan>&lt;=</font> gateId s
<a name="line-599"></a>                    <font color=Cyan>&amp;&amp;</font>
<a name="line-600"></a>                    <font color=Cyan>(</font>lastUsedWire <font color=Cyan>(</font>usedNotWires s<font color=Cyan>)</font> w<font color=Cyan>)</font> <font color=Cyan>&lt;=</font> gateId s
<a name="line-601"></a>
<a name="line-602"></a>          trace <font color=Cyan>(</font><font color=Magenta>"List of outside wires: "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show <font color=Cyan>$</font> outWires s<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>return ()<font color=Cyan>)</font>
<a name="line-603"></a>          trace <font color=Cyan>(</font><font color=Magenta>"List of available wires: "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show all_ws<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>return ()<font color=Cyan>)</font>
<a name="line-604"></a>          trace <font color=Cyan>(</font><font color=Magenta>"List of available wires with neg: "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show all_ws_neg<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>return ()<font color=Cyan>)</font>
<a name="line-605"></a>          
<a name="line-606"></a>          
<a name="line-607"></a>          <font color=Green><u>case</u></font> all_ws <font color=Green><u>of</u></font>
<a name="line-608"></a>            
<a name="line-609"></a>            [] <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-610"></a>              
<a name="line-611"></a>              <font color=Green><u>case</u></font> all_ws_neg <font color=Green><u>of</u></font>
<a name="line-612"></a>                [] <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-613"></a>                   
<a name="line-614"></a>                       <font color=Blue><i>-- There is no "simple" copy-cat...</i></font>
<a name="line-615"></a>                       <font color=Blue><i>-- Let's try to find a hidden one.</i></font>
<a name="line-616"></a>                       
<a name="line-617"></a>                       s <font color=Red>&lt;-</font> getExpState
<a name="line-618"></a>
<a name="line-619"></a>                       <font color=Blue><i>-- This helper function take a wire and look in</i></font>
<a name="line-620"></a>                       <font color=Blue><i>-- the past for the closest cnot acting on it</i></font>
<a name="line-621"></a>                       <font color=Green><u>let</u></font> getOlderCnot w <font color=Red>=</font> <font color=Green><u>case</u></font> <font color=Cyan>(</font><font color=Green><u>do</u></font> set <font color=Red>&lt;-</font> IM.lookup w <font color=Cyan>(</font>usedNotWires s<font color=Cyan>)</font><font color=Cyan>;</font> IS.lookupLT <font color=Cyan>(</font>gateId s<font color=Cyan>)</font> set<font color=Cyan>)</font> <font color=Green><u>of</u></font>
<a name="line-622"></a>                            Nothing <font color=Red>-&gt;</font> Nothing <font color=Blue><i>-- there is no previous not</i></font>
<a name="line-623"></a>                            Just g' <font color=Red>-&gt;</font>         <font color=Blue><i>-- there is one not... let's check that it is a cnot</i></font>
<a name="line-624"></a>                             <font color=Green><u>case</u></font> <font color=Cyan>(</font><font color=Cyan>(</font>past s<font color=Cyan>)</font> <font color=Cyan>!!</font> <font color=Cyan>(</font><font color=Cyan>(</font>gateId s<font color=Cyan>)</font> <font color=Blue><i>-</i></font> g' <font color=Blue><i>-</i></font> <font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Green><u>of</u></font>
<a name="line-625"></a>                             Cnot <font color=Green><u>_</u></font> <font color=Red>[</font>ctl<font color=Red>]</font> <font color=Red>-&gt;</font> Just <font color=Cyan>(</font>g'<font color=Cyan>,</font>ctl<font color=Cyan>)</font>
<a name="line-626"></a>                             <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> Nothing
<a name="line-627"></a>                       
<a name="line-628"></a>                       <font color=Blue><i>-- Helper acting on controls: only return</i></font>
<a name="line-629"></a>                       <font color=Blue><i>-- something if it is a single control.</i></font>
<a name="line-630"></a>                       <font color=Green><u>let</u></font> getOlderCnot_actOnCtls w1 <font color=Red>[</font><font color=Cyan>(</font>w<font color=Cyan>,</font>b<font color=Cyan>)</font><font color=Red>]</font> <font color=Red>=</font> <font color=Green><u>do</u></font> <font color=Blue><i>-- monad Maybe</i></font>
<a name="line-631"></a>                                   other_ctl <font color=Red>&lt;-</font> getOlderCnot w1
<a name="line-632"></a>                                   other_ctl <font color=Cyan>`seq`</font> return <font color=Cyan>(</font><font color=Cyan>(</font>w<font color=Cyan>,</font>b<font color=Cyan>)</font><font color=Cyan>,</font>other_ctl<font color=Cyan>)</font>
<a name="line-633"></a>                           getOlderCnot_actOnCtls <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Red>=</font> Nothing
<a name="line-634"></a>                       
<a name="line-635"></a>                       <font color=Green><u>let</u></font> retrieveHiddenCnot w1 ctls <font color=Red>=</font> <font color=Green><u>do</u></font> <font color=Blue><i>-- monad Maybe</i></font>
<a name="line-636"></a>                               <font color=Blue><i>-- if (L.elem w $ outWires s) then Nothing</i></font>
<a name="line-637"></a>                               <font color=Blue><i>-- else return ()</i></font>
<a name="line-638"></a>                               <font color=Cyan>(</font><font color=Cyan>(</font>w2<font color=Cyan>,</font>b2<font color=Cyan>)</font><font color=Cyan>,</font><font color=Cyan>(</font>g'<font color=Cyan>,</font><font color=Cyan>(</font>w3<font color=Cyan>,</font>b3<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>&lt;-</font> getOlderCnot_actOnCtls w1 ctls
<a name="line-639"></a>                               <font color=Blue><i>-- make sure w2 and w3 are distinct</i></font>
<a name="line-640"></a>                               <font color=Green><u>if</u></font> <font color=Cyan>(</font>w2 <font color=Cyan>==</font> w3<font color=Cyan>)</font> <font color=Green><u>then</u></font> Nothing <font color=Green><u>else</u></font> return ()
<a name="line-641"></a>                               <font color=Green><u>let</u></font> m <font color=Red>=</font> m_after
<a name="line-642"></a>                               <font color=Blue><i>-- check for the property w1 == w2 oplus w3</i></font>
<a name="line-643"></a>                               <font color=Green><u>if</u></font> <font color=Cyan>(</font>S.null <font color=Cyan>$</font> S.intersection
<a name="line-644"></a>                                      <font color=Cyan>(</font>S.fromList <font color=Red>[</font>exp_xor x y <font color=Red>|</font> <font color=Cyan>(</font>x<font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>&lt;-</font> S.toList <font color=Cyan>(</font>m IM<font color=Cyan>.!</font> w2<font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font>y<font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>&lt;-</font> S.toList <font color=Cyan>(</font>m IM<font color=Cyan>.!</font> w3<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>)</font>
<a name="line-645"></a>                                      <font color=Cyan>(</font>S.fromList <font color=Red>[</font>x <font color=Red>|</font> <font color=Cyan>(</font>x<font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>&lt;-</font> S.toList <font color=Cyan>(</font>m IM<font color=Cyan>.!</font> w1<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-646"></a>                               <font color=Green><u>then</u></font> Nothing
<a name="line-647"></a>                               <font color=Blue><i>-- We have two CNOT candidates for hidden copy-cat.</i></font>
<a name="line-648"></a>                               <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> <font color=Cyan>(</font><font color=Cyan>(</font>not <font color=Cyan>(</font>L.elem w2 <font color=Cyan>$</font> outWires s<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-649"></a>                                   <font color=Cyan>&amp;&amp;</font>
<a name="line-650"></a>                                   <font color=Cyan>(</font>lastUsedWire <font color=Cyan>(</font>usedNotWires s<font color=Cyan>)</font> w2<font color=Cyan>)</font> <font color=Cyan>&lt;=</font> gateId s
<a name="line-651"></a>                                   <font color=Cyan>&amp;&amp;</font>
<a name="line-652"></a>                                   <font color=Cyan>(</font>lastUsedWire <font color=Cyan>(</font>usedControlWires s<font color=Cyan>)</font> w2<font color=Cyan>)</font> <font color=Cyan>&lt;=</font> gateId s<font color=Cyan>)</font>
<a name="line-653"></a>                               <font color=Green><u>then</u></font> Just <font color=Cyan>(</font><font color=Cyan>(</font>w2<font color=Cyan>,</font>b2<font color=Cyan>)</font><font color=Cyan>,</font><font color=Cyan>(</font>w3<font color=Cyan>,</font>b3<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-654"></a>                               <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> <font color=Cyan>(</font><font color=Cyan>(</font>not <font color=Cyan>(</font>L.elem w3 <font color=Cyan>$</font> outWires s<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-655"></a>                                        <font color=Cyan>&amp;&amp;</font>
<a name="line-656"></a>                                        <font color=Cyan>(</font>lastUsedWire <font color=Cyan>(</font>usedNotWires s<font color=Cyan>)</font> w3<font color=Cyan>)</font> <font color=Cyan>&lt;=</font> g'
<a name="line-657"></a>                                        <font color=Cyan>&amp;&amp;</font>
<a name="line-658"></a>                                        <font color=Cyan>(</font>lastUsedWire <font color=Cyan>(</font>usedControlWires s<font color=Cyan>)</font> w3<font color=Cyan>)</font> <font color=Cyan>&lt;=</font> g'<font color=Cyan>)</font>
<a name="line-659"></a>                               <font color=Green><u>then</u></font> Just <font color=Cyan>(</font><font color=Cyan>(</font>w3<font color=Cyan>,</font>b3<font color=Cyan>)</font><font color=Cyan>,</font><font color=Cyan>(</font>w2<font color=Cyan>,</font>b2<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-660"></a>                               <font color=Green><u>else</u></font> Nothing
<a name="line-661"></a>                       
<a name="line-662"></a>                       <font color=Green><u>case</u></font> retrieveHiddenCnot w ctls <font color=Green><u>of</u></font>
<a name="line-663"></a>                         Just <font color=Cyan>(</font><font color=Cyan>(</font>w2<font color=Cyan>,</font>b2<font color=Cyan>)</font><font color=Cyan>,</font><font color=Cyan>(</font>w3<font color=Cyan>,</font>b3<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Blue><i>-- we have a hidden cnot candidate. Great.</i></font>
<a name="line-664"></a>                            <font color=Blue><i>-- w2 is the wire that is not used with NOT in future</i></font>
<a name="line-665"></a>                            <font color=Green><u>do</u></font>
<a name="line-666"></a>                            
<a name="line-667"></a>                            trace <font color=Magenta>"found one hidden copy-cat"</font> <font color=Cyan>$</font> return ()
<a name="line-668"></a>                            updateOutWires <font color=Cyan>$</font> map <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> <font color=Green><u>if</u></font> x <font color=Cyan>==</font> w <font color=Green><u>then</u></font> w2 <font color=Green><u>else</u></font> x<font color=Cyan>)</font> 
<a name="line-669"></a>                            
<a name="line-670"></a>                            <font color=Cyan>(</font>gsModifCtls<font color=Cyan>,</font>gsModifNots<font color=Cyan>)</font> <font color=Red>&lt;-</font> updateFuture <font color=Cyan>$</font> moveWire w w2
<a name="line-671"></a>                            
<a name="line-672"></a>                            trace <font color=Cyan>(</font><font color=Magenta>"moving "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show w<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>" to "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show w2<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-673"></a>                            trace <font color=Cyan>(</font>show gsModifCtls<font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-674"></a>                            trace <font color=Cyan>(</font>show gsModifNots<font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-675"></a>                            
<a name="line-676"></a>                            
<a name="line-677"></a>                            s <font color=Red>&lt;-</font> getExpState
<a name="line-678"></a>                            trace <font color=Cyan>(</font><font color=Magenta>"before: usedNotWire = "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show <font color=Cyan>$</font> usedNotWires s<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-679"></a>
<a name="line-680"></a>                            updateUsedControlWires <font color=Cyan>$</font> <font color=Red>\</font>c <font color=Red>-&gt;</font> 
<a name="line-681"></a>                                     IM.alter <font color=Cyan>(</font><font color=Red>\</font>maybe_gs <font color=Red>-&gt;</font> <font color=Green><u>case</u></font> maybe_gs <font color=Green><u>of</u></font>
<a name="line-682"></a>                                                  Just gs <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.union gs gsModifCtls
<a name="line-683"></a>                                                  Nothing <font color=Red>-&gt;</font> Just gsModifCtls<font color=Cyan>)</font>  w2 <font color=Cyan>$</font> 
<a name="line-684"></a>                                     IM.update <font color=Cyan>(</font><font color=Red>\</font>gs <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.difference gs gsModifCtls<font color=Cyan>)</font> w c
<a name="line-685"></a>                            
<a name="line-686"></a>                            updateUsedControlWires <font color=Cyan>$</font> <font color=Red>\</font>c <font color=Red>-&gt;</font> 
<a name="line-687"></a>                                     IM.update <font color=Cyan>(</font><font color=Red>\</font>gs <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.delete <font color=Cyan>(</font>gateId s<font color=Cyan>)</font> gs<font color=Cyan>)</font> w2 c
<a name="line-688"></a>                            updateUsedControlWires <font color=Cyan>$</font> <font color=Red>\</font>c <font color=Red>-&gt;</font> 
<a name="line-689"></a>                                     IM.alter <font color=Cyan>(</font><font color=Red>\</font>maybe_gs <font color=Red>-&gt;</font> <font color=Green><u>case</u></font> maybe_gs <font color=Green><u>of</u></font>
<a name="line-690"></a>                                                  Just gs <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.insert <font color=Cyan>(</font>gateId s<font color=Cyan>)</font> gs
<a name="line-691"></a>                                                  Nothing <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.singleton <font color=Cyan>(</font>gateId s<font color=Cyan>)</font><font color=Cyan>)</font> w3 c
<a name="line-692"></a>                            
<a name="line-693"></a>                            updateUsedNotWires <font color=Cyan>$</font> <font color=Red>\</font>c <font color=Red>-&gt;</font> 
<a name="line-694"></a>                                     IM.alter <font color=Cyan>(</font><font color=Red>\</font>maybe_gs <font color=Red>-&gt;</font> <font color=Green><u>case</u></font> maybe_gs <font color=Green><u>of</u></font>
<a name="line-695"></a>                                                   Just gs <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.union gs gsModifNots
<a name="line-696"></a>                                                   Nothing <font color=Red>-&gt;</font> Just gsModifNots<font color=Cyan>)</font> w2 <font color=Cyan>$</font> 
<a name="line-697"></a>                                     IM.update <font color=Cyan>(</font><font color=Red>\</font>gs <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.difference gs gsModifNots<font color=Cyan>)</font> w c
<a name="line-698"></a>                            
<a name="line-699"></a>                            updateUsedNotWires <font color=Cyan>$</font> <font color=Red>\</font>c <font color=Red>-&gt;</font> 
<a name="line-700"></a>                                     IM.update <font color=Cyan>(</font><font color=Red>\</font>gs <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.delete <font color=Cyan>(</font>gateId s<font color=Cyan>)</font> gs<font color=Cyan>)</font> w <font color=Cyan>$</font>
<a name="line-701"></a>                                     IM.alter <font color=Cyan>(</font><font color=Red>\</font>maybe_gs <font color=Red>-&gt;</font> <font color=Green><u>case</u></font> maybe_gs <font color=Green><u>of</u></font>
<a name="line-702"></a>                                                  Just gs <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.insert <font color=Cyan>(</font>gateId s<font color=Cyan>)</font> gs
<a name="line-703"></a>                                                  Nothing <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.singleton <font color=Cyan>(</font>gateId s<font color=Cyan>)</font><font color=Cyan>)</font> w2 c
<a name="line-704"></a>                            
<a name="line-705"></a>                            s <font color=Red>&lt;-</font> getExpState
<a name="line-706"></a>                            trace <font color=Cyan>(</font><font color=Magenta>"after: usedNotWire = "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show <font color=Cyan>$</font> usedNotWires s<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-707"></a>
<a name="line-708"></a>                            <font color=Blue><i>-- Update ExpMap</i></font>
<a name="line-709"></a>                            setExpMap <font color=Cyan>$</font> IM.insert w <font color=Cyan>(</font>m_before IM<font color=Cyan>.!</font> w<font color=Cyan>)</font> <font color=Cyan>$</font>
<a name="line-710"></a>                                        IM.insert w2 <font color=Cyan>(</font>m_after IM<font color=Cyan>.!</font> w<font color=Cyan>)</font> m_after
<a name="line-711"></a>                            
<a name="line-712"></a>                            storeOldGate <font color=Cyan>$</font> Cnot w2 <font color=Red>[</font><font color=Cyan>(</font>w3<font color=Cyan>,</font>True<font color=Cyan>)</font><font color=Red>]</font>
<a name="line-713"></a>                            incrGateId
<a name="line-714"></a>                            return True
<a name="line-715"></a>                            
<a name="line-716"></a>                         <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> <font color=Blue><i>-- No hidden Cnot, let's proceed...</i></font>
<a name="line-717"></a>                            <font color=Green><u>do</u></font>
<a name="line-718"></a>                            <font color=Green><u>let</u></font> mw <font color=Red>=</font> m_after IM<font color=Cyan>.!</font> w
<a name="line-719"></a>                            f <font color=Red>&lt;-</font> <font color=Green><u>if</u></font> <font color=Cyan>(</font><font color=Cyan>(</font>S.foldl' <font color=Cyan>(</font><font color=Red>\</font>a <font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Cyan>,</font>i<font color=Cyan>)</font> <font color=Red>-&gt;</font> min a i<font color=Cyan>)</font> <font color=Magenta>3</font> mw<font color=Cyan>)</font> <font color=Cyan>&lt;=</font> <font color=Magenta>1</font><font color=Cyan>)</font> 
<a name="line-720"></a>                                 <font color=Green><u>then</u></font> return id 
<a name="line-721"></a>                                 <font color=Green><u>else</u></font> <font color=Green><u>do</u></font>
<a name="line-722"></a>                                      v <font color=Red>&lt;-</font> newFreshVar
<a name="line-723"></a>                                      return <font color=Cyan>(</font>S.insert <font color=Cyan>(</font>exp_var <font color=Cyan>$</font> fromIntegral v<font color=Cyan>,</font> <font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-724"></a>                            setExpMap <font color=Cyan>$</font> IM.adjust <font color=Cyan>(</font><font color=Red>\</font>a <font color=Red>-&gt;</font> pruneListExp <font color=Magenta>3</font> a<font color=Cyan>)</font> w <font color=Cyan>$</font> 
<a name="line-725"></a>                                        IM.adjust f w m_after
<a name="line-726"></a>          
<a name="line-727"></a>                            storeOldGate g
<a name="line-728"></a>                            incrGateId
<a name="line-729"></a>                            return True
<a name="line-730"></a>
<a name="line-731"></a>                <font color=Blue><i>-----------------</i></font>
<a name="line-732"></a>                <font color=Blue><i>-- Case of simple copy-cats</i></font>
<a name="line-733"></a>                <font color=Cyan>(</font>w'<font color=Red><b>:</b></font><font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-734"></a>                   s <font color=Red>&lt;-</font> getExpState
<a name="line-735"></a>                   updateOutWires <font color=Cyan>$</font> map <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> <font color=Green><u>if</u></font> x <font color=Cyan>==</font> w <font color=Green><u>then</u></font> w' <font color=Green><u>else</u></font> x<font color=Cyan>)</font>
<a name="line-736"></a>                   
<a name="line-737"></a>                   s <font color=Red>&lt;-</font> getExpState
<a name="line-738"></a>                   trace <font color=Cyan>(</font>show <font color=Cyan>$</font> future s<font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-739"></a>                   <font color=Cyan>(</font>gsModifCtls<font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>&lt;-</font> updateFuture <font color=Cyan>$</font> moveWireFlip w w'
<a name="line-740"></a>                   
<a name="line-741"></a>                   <font color=Blue><i>-- update expMap: now, w is null and w' is not(old w)</i></font>
<a name="line-742"></a>                   expMap <font color=Red>&lt;-</font> getExpMap
<a name="line-743"></a>                   
<a name="line-744"></a>                   setExpMap <font color=Cyan>$</font> IM.insert w <font color=Cyan>(</font>m_before IM<font color=Cyan>.!</font> w<font color=Cyan>)</font> <font color=Cyan>$</font>
<a name="line-745"></a>                               IM.insert w' <font color=Cyan>(</font>S.map <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>e<font color=Cyan>,</font>i<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>exp_not e<font color=Cyan>,</font>i<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>expMap IM<font color=Cyan>.!</font> w'<font color=Cyan>)</font><font color=Cyan>)</font> expMap
<a name="line-746"></a>                   
<a name="line-747"></a>                   
<a name="line-748"></a>                   
<a name="line-749"></a>                   trace <font color=Cyan>(</font><font color=Magenta>"moving "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show w<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>" to "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show w'<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-750"></a>                   trace <font color=Cyan>(</font>show gsModifCtls<font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-751"></a>                   s <font color=Red>&lt;-</font> getExpState
<a name="line-752"></a>                   trace <font color=Cyan>(</font>show <font color=Cyan>$</font> future s<font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-753"></a>                   
<a name="line-754"></a>                   s <font color=Red>&lt;-</font> getExpState
<a name="line-755"></a>                   updateUsedControlWires <font color=Cyan>$</font> <font color=Red>\</font>c <font color=Red>-&gt;</font> 
<a name="line-756"></a>                            IM.alter <font color=Cyan>(</font><font color=Red>\</font>maybe_gs <font color=Red>-&gt;</font> <font color=Green><u>case</u></font> maybe_gs <font color=Green><u>of</u></font>
<a name="line-757"></a>                                     Just gs <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.union gs gsModifCtls
<a name="line-758"></a>                                     Nothing <font color=Red>-&gt;</font> Just gsModifCtls<font color=Cyan>)</font> w' <font color=Cyan>$</font> 
<a name="line-759"></a>                            IM.update <font color=Cyan>(</font><font color=Red>\</font>gs <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.difference gs gsModifCtls<font color=Cyan>)</font> w c
<a name="line-760"></a>                   updateUsedNotWires <font color=Cyan>$</font> <font color=Red>\</font>c <font color=Red>-&gt;</font> 
<a name="line-761"></a>                            IM.update <font color=Cyan>(</font><font color=Red>\</font>gs <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.delete <font color=Cyan>(</font>gateId s<font color=Cyan>)</font> gs<font color=Cyan>)</font> w c
<a name="line-762"></a>
<a name="line-763"></a>                   storeOldGate <font color=Cyan>(</font>Cnot w' []<font color=Cyan>)</font> <font color=Blue><i>-- Set a flip on the w' wire </i></font>
<a name="line-764"></a>                   
<a name="line-765"></a>                   incrGateId
<a name="line-766"></a>                   
<a name="line-767"></a>                   return True
<a name="line-768"></a>     
<a name="line-769"></a>                
<a name="line-770"></a>                   
<a name="line-771"></a>            <font color=Cyan>(</font>w'<font color=Red><b>:</b></font><font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-772"></a>              
<a name="line-773"></a>              s <font color=Red>&lt;-</font> getExpState
<a name="line-774"></a>              updateOutWires <font color=Cyan>$</font> map <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> <font color=Green><u>if</u></font> x <font color=Cyan>==</font> w <font color=Green><u>then</u></font> w' <font color=Green><u>else</u></font> x<font color=Cyan>)</font> 
<a name="line-775"></a>
<a name="line-776"></a>              s <font color=Red>&lt;-</font> getExpState
<a name="line-777"></a>              trace <font color=Cyan>(</font>show <font color=Cyan>$</font> future s<font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-778"></a>              trace <font color=Cyan>(</font><font color=Magenta>"usedNotWire = "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show <font color=Cyan>$</font> usedNotWires s<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-779"></a>              <font color=Cyan>(</font>gsModifCtls<font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>&lt;-</font> updateFuture <font color=Cyan>$</font> moveWire w w'
<a name="line-780"></a>              
<a name="line-781"></a>              trace <font color=Cyan>(</font><font color=Magenta>"moving "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show w<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>" to "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show w'<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-782"></a>              trace <font color=Cyan>(</font>show gsModifCtls<font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-783"></a>              s <font color=Red>&lt;-</font> getExpState
<a name="line-784"></a>              trace <font color=Cyan>(</font>show <font color=Cyan>$</font> future s<font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-785"></a>              
<a name="line-786"></a>              s <font color=Red>&lt;-</font> getExpState
<a name="line-787"></a>              updateUsedControlWires <font color=Cyan>$</font> <font color=Red>\</font>c <font color=Red>-&gt;</font> 
<a name="line-788"></a>                       IM.alter <font color=Cyan>(</font><font color=Red>\</font>maybe_gs <font color=Red>-&gt;</font> <font color=Green><u>case</u></font> maybe_gs <font color=Green><u>of</u></font>
<a name="line-789"></a>                                     Just gs <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.union gs gsModifCtls
<a name="line-790"></a>                                     Nothing <font color=Red>-&gt;</font> Just gsModifCtls
<a name="line-791"></a>                                     <font color=Cyan>)</font> w' <font color=Cyan>$</font> 
<a name="line-792"></a>                       IM.update <font color=Cyan>(</font><font color=Red>\</font>gs <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.difference gs gsModifCtls<font color=Cyan>)</font> w c
<a name="line-793"></a>              updateUsedNotWires <font color=Cyan>$</font> <font color=Red>\</font>c <font color=Red>-&gt;</font> 
<a name="line-794"></a>                       IM.update <font color=Cyan>(</font><font color=Red>\</font>gs <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.delete <font color=Cyan>(</font>gateId s<font color=Cyan>)</font> gs<font color=Cyan>)</font> w c
<a name="line-795"></a>              
<a name="line-796"></a>              storeOldGate NoOp <font color=Blue><i>-- replace g with NoOp so that gateId stays accurate</i></font>
<a name="line-797"></a>              incrGateId
<a name="line-798"></a>              
<a name="line-799"></a>              return True
<a name="line-800"></a>
<a name="line-801"></a>
<a name="line-802"></a><a name="stepSwapCirc"></a><font color=Blue><i>-- | Shuffle the circuit by sending the CNOT gates as far as</i></font>
<a name="line-803"></a><font color=Blue><i>-- possible (i.e., until they hit a control, or to the end).</i></font>
<a name="line-804"></a><font color=Blue><i>-- Return 'False' when the end of the circuit is reached, 'True' otherwise. </i></font>
<a name="line-805"></a><font color=Blue>stepSwapCirc</font> <font color=Red>::</font> EvalCirc Bool
<a name="line-806"></a><font color=Blue>stepSwapCirc</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-807"></a>  s <font color=Red>&lt;-</font> getExpState
<a name="line-808"></a>  
<a name="line-809"></a>  <font color=Green><u>case</u></font> <font color=Cyan>(</font>IM.lookup <font color=Cyan>(</font>gateId s<font color=Cyan>)</font> <font color=Cyan>(</font>gates_to_skip s<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Green><u>of</u></font>
<a name="line-810"></a>    
<a name="line-811"></a>    Just g <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> 
<a name="line-812"></a>      
<a name="line-813"></a>      storeOldGate g
<a name="line-814"></a>      incrGateId
<a name="line-815"></a>      return True
<a name="line-816"></a>    
<a name="line-817"></a>    Nothing <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-818"></a>      
<a name="line-819"></a>      maybe_g <font color=Red>&lt;-</font> pullNewGate
<a name="line-820"></a>      trace <font color=Cyan>(</font><font color=Magenta>"pulled new gate "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show maybe_g<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-821"></a>      s <font color=Red>&lt;-</font> getExpState
<a name="line-822"></a>      <font color=Green><u>if</u></font> <font color=Cyan>(</font><font color=Cyan>(</font>gateId s<font color=Cyan>)</font> <font color=Cyan>`mod`</font> <font color=Magenta>1000</font> <font color=Cyan>==</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Green><u>then</u></font> trace <font color=Cyan>(</font><font color=Magenta>"Timestamp (swap)... "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show <font color=Cyan>(</font>gateId s<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Blue><i>{-(s `Seq.deepseq` (setExpState s))-}</i></font> <font color=Cyan>(</font>return ()<font color=Cyan>)</font>  <font color=Green><u>else</u></font> return ()
<a name="line-823"></a>      <font color=Green><u>case</u></font> maybe_g <font color=Green><u>of</u></font>
<a name="line-824"></a>      
<a name="line-825"></a>        Nothing <font color=Red>-&gt;</font> return False
<a name="line-826"></a>        
<a name="line-827"></a>        Just g<font color=Red>@</font><font color=Cyan>(</font>Cnot w1 <font color=Red>[</font><font color=Cyan>(</font>w2<font color=Cyan>,</font>b2<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>)</font> <font color=Red>|</font> IM.notMember <font color=Cyan>(</font>gateId s<font color=Cyan>)</font> <font color=Cyan>(</font>gates_to_skip s<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> <font color=Blue><i>-- got a CNOT</i></font>
<a name="line-828"></a>        
<a name="line-829"></a>          trace <font color=Cyan>(</font><font color=Magenta>"got a cnot to analyze "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show <font color=Cyan>$</font> gateId s<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Magenta>" "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show <font color=Cyan>$</font> gates_to_skip s<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-830"></a>          
<a name="line-831"></a>          <font color=Green><u>let</u></font> id <font color=Red>=</font> min <font color=Cyan>(</font>nextUsedGate <font color=Cyan>(</font>usedNotWires s<font color=Cyan>)</font> <font color=Cyan>(</font>gateId s<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>1</font> <font color=Cyan>+</font> sizeCirc s<font color=Cyan>)</font> w2<font color=Cyan>)</font> <font color=Cyan>$</font>
<a name="line-832"></a>                       <font color=Cyan>(</font>nextUsedGate <font color=Cyan>(</font>usedControlWires s<font color=Cyan>)</font> <font color=Cyan>(</font>gateId s<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>1</font> <font color=Cyan>+</font> sizeCirc s<font color=Cyan>)</font> w1<font color=Cyan>)</font>
<a name="line-833"></a>          
<a name="line-834"></a>          trace <font color=Cyan>(</font><font color=Magenta>"found id = "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show id<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-835"></a>          
<a name="line-836"></a>          <font color=Green><u>if</u></font> <font color=Cyan>(</font> id <font color=Cyan>&gt;</font>  <font color=Magenta>1</font> <font color=Cyan>+</font> gateId s <font color=Cyan>)</font> <font color=Blue><i>--  &amp;&amp; (id &lt;= (sizeCirc s) )</i></font>
<a name="line-837"></a>            <font color=Green><u>then</u></font> <font color=Green><u>do</u></font> <font color=Blue><i>------------- there is something to move!</i></font>
<a name="line-838"></a>              trace <font color=Cyan>(</font><font color=Magenta>"can be shifted to "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show <font color=Cyan>(</font>id <font color=Blue><i>-</i></font> <font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-839"></a>              
<a name="line-840"></a>              addToSkipGates <font color=Cyan>(</font>id <font color=Blue><i>-</i></font> <font color=Magenta>1</font><font color=Cyan>)</font> g
<a name="line-841"></a>              <font color=Blue><i>-- shiftGate g (id - 1 - (gateId s))</i></font>
<a name="line-842"></a>              
<a name="line-843"></a>              s <font color=Red>&lt;-</font> getExpState
<a name="line-844"></a>              trace <font color=Cyan>(</font>show <font color=Cyan>$</font> future s<font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-845"></a>              
<a name="line-846"></a>              <font color=Blue><i>-- Remove references to (gateId s)</i></font>
<a name="line-847"></a>              
<a name="line-848"></a>              updateUsedControlWires <font color=Cyan>$</font> <font color=Red>\</font>c <font color=Red>-&gt;</font> 
<a name="line-849"></a>                       IM.update <font color=Cyan>(</font><font color=Red>\</font>gs <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.delete <font color=Cyan>(</font>gateId s<font color=Cyan>)</font> gs<font color=Cyan>)</font> w2 c
<a name="line-850"></a>              updateUsedNotWires <font color=Cyan>$</font> <font color=Red>\</font>c <font color=Red>-&gt;</font> 
<a name="line-851"></a>                       IM.update <font color=Cyan>(</font><font color=Red>\</font>gs <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.delete <font color=Cyan>(</font>gateId s<font color=Cyan>)</font> gs<font color=Cyan>)</font> w1 c
<a name="line-852"></a>              
<a name="line-853"></a>              <font color=Blue><i>-- Shift the ones between (gateId s) and id</i></font>
<a name="line-854"></a>              
<a name="line-855"></a>              updateUsedNotWires <font color=Cyan>$</font>
<a name="line-856"></a>                       IM.map <font color=Cyan>$</font> IS.map <font color=Cyan>$</font> <font color=Red>\</font>x <font color=Red>-&gt;</font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>x <font color=Cyan>&lt;=</font> gateId s<font color=Cyan>)</font> <font color=Cyan>||</font> <font color=Cyan>(</font>x <font color=Cyan>&gt;=</font> id<font color=Cyan>)</font> <font color=Green><u>then</u></font> x 
<a name="line-857"></a>                                               <font color=Green><u>else</u></font> x <font color=Blue><i>-</i></font> <font color=Magenta>1</font>
<a name="line-858"></a>              updateUsedControlWires <font color=Cyan>$</font>
<a name="line-859"></a>                       IM.map <font color=Cyan>$</font> IS.map <font color=Cyan>$</font> <font color=Red>\</font>x <font color=Red>-&gt;</font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>x <font color=Cyan>&lt;=</font> gateId s<font color=Cyan>)</font> <font color=Cyan>||</font> <font color=Cyan>(</font>x <font color=Cyan>&gt;=</font> id<font color=Cyan>)</font> <font color=Green><u>then</u></font> x 
<a name="line-860"></a>                                               <font color=Green><u>else</u></font> x <font color=Blue><i>-</i></font> <font color=Magenta>1</font>
<a name="line-861"></a>              
<a name="line-862"></a>              s <font color=Red>&lt;-</font> getExpState
<a name="line-863"></a>              <font color=Green><u>let</u></font> z <font color=Red>=</font> IM.mapKeys <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> <font color=Green><u>if</u></font> <font color=Cyan>(</font>x <font color=Cyan>&lt;=</font> gateId s<font color=Cyan>)</font> <font color=Cyan>||</font> <font color=Cyan>(</font>x <font color=Cyan>&gt;=</font> id<font color=Cyan>)</font> <font color=Green><u>then</u></font> x 
<a name="line-864"></a>                                    <font color=Green><u>else</u></font> x <font color=Blue><i>-</i></font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>(</font>gates_to_skip s<font color=Cyan>)</font> <font color=Green><u>in</u></font>
<a name="line-865"></a>                 z <font color=Cyan>`seq`</font> setExpState <font color=Cyan>(</font>s <font color=Cyan>{</font> gates_to_skip <font color=Red>=</font> z<font color=Cyan>}</font> <font color=Cyan>)</font>
<a name="line-866"></a>      
<a name="line-867"></a>              <font color=Blue><i>-- Set g in position (id - 1)</i></font>
<a name="line-868"></a>                    
<a name="line-869"></a>              updateUsedControlWires <font color=Cyan>$</font> <font color=Red>\</font>c <font color=Red>-&gt;</font> 
<a name="line-870"></a>                       IM.alter <font color=Cyan>(</font><font color=Red>\</font>maybe_gs <font color=Red>-&gt;</font> <font color=Green><u>case</u></font> maybe_gs <font color=Green><u>of</u></font>
<a name="line-871"></a>                                    Just gs <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.insert <font color=Cyan>(</font>id <font color=Blue><i>-</i></font> <font color=Magenta>1</font><font color=Cyan>)</font> gs
<a name="line-872"></a>                                    Nothing <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.singleton <font color=Cyan>(</font>id <font color=Blue><i>-</i></font> <font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> w2 c
<a name="line-873"></a>              updateUsedNotWires <font color=Cyan>$</font> <font color=Red>\</font>c <font color=Red>-&gt;</font> 
<a name="line-874"></a>                       IM.alter <font color=Cyan>(</font><font color=Red>\</font>maybe_gs <font color=Red>-&gt;</font> <font color=Green><u>case</u></font> maybe_gs <font color=Green><u>of</u></font>
<a name="line-875"></a>                                     Just gs <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.insert <font color=Cyan>(</font>id <font color=Blue><i>-</i></font> <font color=Magenta>1</font><font color=Cyan>)</font> gs
<a name="line-876"></a>                                     Nothing <font color=Red>-&gt;</font> Just <font color=Cyan>$</font> IS.singleton <font color=Cyan>(</font>id <font color=Blue><i>-</i></font> <font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> w1 c
<a name="line-877"></a>              
<a name="line-878"></a>              <font color=Blue><i>-- Make sure we skip (id - 1) later on.</i></font>
<a name="line-879"></a>              
<a name="line-880"></a>              
<a name="line-881"></a>          <font color=Green><u>else</u></font> <font color=Green><u>do</u></font> <font color=Blue><i>------------- nothing to move...    </i></font>
<a name="line-882"></a>              trace <font color=Magenta>"cannot be shifted"</font> <font color=Cyan>$</font> return ()
<a name="line-883"></a>              storeOldGate g
<a name="line-884"></a>              incrGateId
<a name="line-885"></a>              
<a name="line-886"></a>          return True
<a name="line-887"></a>          
<a name="line-888"></a>        Just g <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-889"></a>          trace <font color=Cyan>(</font><font color=Magenta>"got a random "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show g<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-890"></a>          storeOldGate g
<a name="line-891"></a>          incrGateId
<a name="line-892"></a>          return True
<a name="line-893"></a>
<a name="line-894"></a>
<a name="line-895"></a>
<a name="line-896"></a><a name="stepSwapCirc_simple"></a><font color=Blue><i>-- | A more elementary version of @'stepSwapCirc'@: shuffle the</i></font>
<a name="line-897"></a><font color=Blue><i>-- circuit by sending to the end all the NOT gates that can be sent</i></font>
<a name="line-898"></a><font color=Blue><i>-- there. Return 'False' when the end of the circuit is reached,</i></font>
<a name="line-899"></a><font color=Blue><i>-- 'True' otherwise.</i></font>
<a name="line-900"></a><font color=Blue>stepSwapCirc_simple</font>  <font color=Red>::</font> EvalCirc Bool
<a name="line-901"></a><font color=Blue>stepSwapCirc_simple</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-902"></a>  maybe_g <font color=Red>&lt;-</font> pullNewGate
<a name="line-903"></a>  trace <font color=Cyan>(</font><font color=Magenta>"pulled new gate "</font> <font color=Cyan>++</font> <font color=Cyan>(</font>show maybe_g<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> return ()
<a name="line-904"></a>  s <font color=Red>&lt;-</font> getExpState
<a name="line-905"></a>  <font color=Green><u>case</u></font> maybe_g <font color=Green><u>of</u></font>
<a name="line-906"></a>
<a name="line-907"></a>    Nothing <font color=Red>-&gt;</font> return False
<a name="line-908"></a>    
<a name="line-909"></a>    Just g <font color=Red>|</font> <font color=Cyan>(</font>gateId s<font color=Cyan>)</font> <font color=Cyan>==</font> <font color=Cyan>(</font>length <font color=Cyan>$</font> past s<font color=Cyan>)</font> <font color=Cyan>+</font> <font color=Cyan>(</font>length <font color=Cyan>$</font> future s<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-910"></a>        storeOldGate g
<a name="line-911"></a>        return False 
<a name="line-912"></a>          
<a name="line-913"></a>    Just g<font color=Red>@</font><font color=Cyan>(</font>Cnot w1 <font color=Red>[</font><font color=Cyan>(</font>w2<font color=Cyan>,</font>b2<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>)</font> <font color=Red>|</font> 
<a name="line-914"></a>        <font color=Cyan>(</font>lastUsedWire <font color=Cyan>(</font>usedNotWires s<font color=Cyan>)</font> w2<font color=Cyan>)</font> <font color=Cyan>&lt;=</font> gateId s <font color=Cyan>&amp;&amp;</font> 
<a name="line-915"></a>        <font color=Cyan>(</font>lastUsedWire <font color=Cyan>(</font>usedNotWires s<font color=Cyan>)</font> w1<font color=Cyan>)</font> <font color=Cyan>&lt;=</font> gateId s <font color=Cyan>&amp;&amp;</font>
<a name="line-916"></a>        <font color=Cyan>(</font>lastUsedWire <font color=Cyan>(</font>usedControlWires s<font color=Cyan>)</font> w1<font color=Cyan>)</font> <font color=Cyan>&lt;=</font> gateId s <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> <font color=Blue><i>-- got a CNOT</i></font>
<a name="line-917"></a>
<a name="line-918"></a>      trace <font color=Magenta>"got a cnot that can be sent to the end"</font> <font color=Cyan>$</font> return ()
<a name="line-919"></a>      
<a name="line-920"></a>      sendEndOfTime g
<a name="line-921"></a>      <font color=Blue><i>-- do not store gate, but increase gateId</i></font>
<a name="line-922"></a>      incrGateId
<a name="line-923"></a>      return True
<a name="line-924"></a>      
<a name="line-925"></a>    Just g <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-926"></a>      storeOldGate g
<a name="line-927"></a>      incrGateId
<a name="line-928"></a>      return True
<a name="line-929"></a>
<a name="line-930"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-931"></a><font color=Blue><i>-- ** Some wrappers</i></font>
<a name="line-932"></a>
<a name="line-933"></a><a name="runWhile"></a><font color=Blue><i>-- | Run the monad until 'False' occurs.</i></font>
<a name="line-934"></a><font color=Blue>runWhile</font> <font color=Red>::</font> Monad m <font color=Red>=&gt;</font> <font color=Cyan>(</font>a <font color=Red>-&gt;</font> Bool<font color=Cyan>)</font> <font color=Red>-&gt;</font> m a <font color=Red>-&gt;</font> m ()
<a name="line-935"></a><font color=Blue>runWhile</font> f c <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-936"></a>  r <font color=Red>&lt;-</font> c
<a name="line-937"></a>  <font color=Green><u>if</u></font> f r <font color=Green><u>then</u></font> runWhile f c <font color=Green><u>else</u></font> return ()
<a name="line-938"></a>
<a name="line-939"></a><a name="stripNoOp"></a><font color=Blue><i>-- | Strip the 'NoOp' gates from a list of gates.</i></font>
<a name="line-940"></a><font color=Blue>stripNoOp</font> <font color=Red>::</font> <font color=Red>[</font>Gate<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Gate<font color=Red>]</font>
<a name="line-941"></a><font color=Blue>stripNoOp</font> <font color=Red>=</font> L.filter <font color=Cyan>(</font><font color=Cyan>/=</font> NoOp<font color=Cyan>)</font> 
<a name="line-942"></a>
<a name="line-943"></a><a name="alg_simplify"></a><font color=Blue><i>-- | Wrapper around 'stepEvalCirc'.</i></font>
<a name="line-944"></a><font color=Blue>alg_simplify</font> <font color=Red>::</font> <font color=Cyan>(</font><font color=Red>[</font>Gate<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Gate<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-945"></a><font color=Blue>alg_simplify</font> <font color=Cyan>(</font>gs<font color=Cyan>,</font>out<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>stripNoOp gs'<font color=Cyan>,</font>out'<font color=Cyan>)</font>
<a name="line-946"></a>  <font color=Green><u>where</u></font>
<a name="line-947"></a>    gs' <font color=Red>=</font> <font color=Cyan>(</font>reverse <font color=Cyan>$</font> past s<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Cyan>(</font>future s<font color=Cyan>)</font>
<a name="line-948"></a>    out' <font color=Red>=</font> outWires s
<a name="line-949"></a>    ws_in <font color=Red>=</font> getAllWires gs
<a name="line-950"></a>    s <font color=Red>=</font> runEvalCirc ws_in out gs <font color=Cyan>$</font> trace <font color=Magenta>"Starting new circuit!"</font> <font color=Cyan>(</font>runWhile id stepEvalCirc<font color=Cyan>)</font>
<a name="line-951"></a>
<a name="line-952"></a><a name="alg_swap"></a><font color=Blue><i>-- | Wrapper around 'stepSwapCirc'.</i></font>
<a name="line-953"></a><font color=Blue>alg_swap</font> <font color=Red>::</font> <font color=Cyan>(</font><font color=Red>[</font>Gate<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Gate<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-954"></a><font color=Blue>alg_swap</font> <font color=Cyan>(</font>gs<font color=Cyan>,</font>out<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>stripNoOp gs'<font color=Cyan>,</font>out'<font color=Cyan>)</font>
<a name="line-955"></a>  <font color=Green><u>where</u></font>
<a name="line-956"></a>    gs' <font color=Red>=</font> <font color=Cyan>(</font>reverse <font color=Cyan>$</font> past s<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Cyan>(</font>future s<font color=Cyan>)</font>
<a name="line-957"></a>    out' <font color=Red>=</font> outWires s
<a name="line-958"></a>    ws_in <font color=Red>=</font> getAllWires gs
<a name="line-959"></a>    s <font color=Red>=</font> runEvalCirc ws_in out gs <font color=Cyan>$</font> trace <font color=Magenta>"Starting new circuit!"</font> <font color=Cyan>(</font>runWhile id stepSwapCirc<font color=Cyan>)</font>
<a name="line-960"></a>
<a name="line-961"></a>
<a name="line-962"></a><a name="alg_swap_simple"></a><font color=Blue><i>-- | Wrapper around 'stepSwapCirc_simple'.</i></font>
<a name="line-963"></a><font color=Blue>alg_swap_simple</font> <font color=Red>::</font> <font color=Cyan>(</font><font color=Red>[</font>Gate<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Gate<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-964"></a><font color=Blue>alg_swap_simple</font> <font color=Cyan>(</font>gs<font color=Cyan>,</font>out<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>stripNoOp gs'<font color=Cyan>,</font>out'<font color=Cyan>)</font>
<a name="line-965"></a>  <font color=Green><u>where</u></font>
<a name="line-966"></a>    gs' <font color=Red>=</font> <font color=Cyan>(</font>reverse <font color=Cyan>$</font> past s<font color=Cyan>)</font> <font color=Cyan>++</font> <font color=Cyan>(</font>future s<font color=Cyan>)</font>
<a name="line-967"></a>    out' <font color=Red>=</font> outWires s
<a name="line-968"></a>    ws_in <font color=Red>=</font> getAllWires gs
<a name="line-969"></a>    s <font color=Red>=</font> runEvalCirc ws_in out gs <font color=Cyan>$</font> trace <font color=Magenta>"Starting new circuit!"</font> <font color=Cyan>(</font>runWhile id stepSwapCirc_simple<font color=Cyan>)</font>
<a name="line-970"></a>
<a name="line-971"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-972"></a><font color=Blue><i>-- * Multi-pass optimization</i></font>
<a name="line-973"></a>
<a name="line-974"></a><a name="is_equal_list"></a><font color=Blue><i>-- | Auxiliary function. Simultaneously compute the maximum of the</i></font>
<a name="line-975"></a><font color=Blue><i>-- lengths of two lists, and their point-wise equality.</i></font>
<a name="line-976"></a><font color=Blue>is_equal_list</font> <font color=Red>::</font> Eq a <font color=Red>=&gt;</font> <font color=Red>[</font>a<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>a<font color=Red>]</font> <font color=Red>-&gt;</font> Int <font color=Red>-&gt;</font> <font color=Cyan>(</font>Int<font color=Cyan>,</font>Bool<font color=Cyan>)</font>
<a name="line-977"></a>
<a name="line-978"></a><font color=Blue>is_equal_list</font> [] [] n                      <font color=Red>=</font> <font color=Cyan>(</font>n<font color=Cyan>,</font>True<font color=Cyan>)</font>
<a name="line-979"></a><font color=Blue>is_equal_list</font> <font color=Cyan>(</font>h1<font color=Red><b>:</b></font>t1<font color=Cyan>)</font> <font color=Cyan>(</font>h2<font color=Red><b>:</b></font>t2<font color=Cyan>)</font> n <font color=Red>|</font> h1 <font color=Cyan>==</font> h2 <font color=Red>=</font> is_equal_list t1 t2 <font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-980"></a><font color=Blue>is_equal_list</font> t1 t2 n                        <font color=Red>=</font> <font color=Cyan>(</font>n <font color=Cyan>+</font> max <font color=Cyan>(</font>length t1<font color=Cyan>)</font> <font color=Cyan>(</font>length t2<font color=Cyan>)</font><font color=Cyan>,</font>False<font color=Cyan>)</font>
<a name="line-981"></a>
<a name="line-982"></a><a name="get_list_init"></a><font color=Blue><i>-- | Get the list of initialized wires from a circuit.</i></font>
<a name="line-983"></a><font color=Blue>get_list_init</font> <font color=Red>::</font> <font color=Red>[</font>Gate<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font>
<a name="line-984"></a><font color=Blue>get_list_init</font> <font color=Cyan>(</font><font color=Cyan>(</font>Init <font color=Green><u>_</u></font> w<font color=Cyan>)</font><font color=Red><b>:</b></font>gs<font color=Cyan>)</font> <font color=Red>=</font> w<font color=Red><b>:</b></font><font color=Cyan>(</font>get_list_init gs<font color=Cyan>)</font>
<a name="line-985"></a><font color=Blue>get_list_init</font> <font color=Cyan>(</font>g<font color=Red><b>:</b></font>gs<font color=Cyan>)</font> <font color=Red>=</font> get_list_init gs
<a name="line-986"></a><font color=Blue>get_list_init</font> [] <font color=Red>=</font> []
<a name="line-987"></a>
<a name="line-988"></a><a name="simplRec'"></a><font color=Blue><i>-- | Do several passes of @'alg_simplify'@ until it reaches a fixed point.</i></font>
<a name="line-989"></a><font color=Blue>simplRec'</font> <font color=Red>::</font> <font color=Cyan>(</font><font color=Red>[</font>Gate<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Gate<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-990"></a><font color=Blue>simplRec'</font> <font color=Cyan>(</font>l<font color=Cyan>,</font>output<font color=Cyan>)</font> <font color=Red>=</font> trace <font color=Cyan>(</font>show <font color=Cyan>(</font>l<font color=Cyan>,</font>output<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>$</font> 
<a name="line-991"></a>   <font color=Green><u>let</u></font> <font color=Cyan>(</font>l'<font color=Cyan>,</font>output'<font color=Cyan>)</font> <font color=Red>=</font> alg_simplify <font color=Cyan>(</font>l<font color=Cyan>,</font> output<font color=Cyan>)</font> <font color=Green><u>in</u></font>
<a name="line-992"></a>   <font color=Green><u>let</u></font> <font color=Cyan>(</font>n<font color=Cyan>,</font>b<font color=Cyan>)</font> <font color=Red>=</font> is_equal_list l l' <font color=Magenta>0</font> <font color=Green><u>in</u></font>
<a name="line-993"></a>   <font color=Green><u>if</u></font> b <font color=Green><u>then</u></font> <font color=Cyan>(</font>l<font color=Cyan>,</font>output<font color=Cyan>)</font> 
<a name="line-994"></a>   <font color=Green><u>else</u></font> trace <font color=Cyan>(</font>show n<font color=Cyan>)</font> simplRec' <font color=Cyan>$</font> suppressGarbageGates <font color=Cyan>(</font>l'<font color=Cyan>,</font>output'<font color=Cyan>)</font>
<a name="line-995"></a>
<a name="line-996"></a><a name="simplRec"></a><font color=Blue><i>-- | Do several passed of @'alg_swap'@ followed with @'simplRec'@</i></font>
<a name="line-997"></a><font color=Blue><i>-- until it reaches a fixed point.</i></font>
<a name="line-998"></a><font color=Blue>simplRec</font> <font color=Red>::</font> <font color=Cyan>(</font><font color=Red>[</font>Gate<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Gate<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-999"></a><font color=Blue>simplRec</font> <font color=Cyan>(</font>l1<font color=Cyan>,</font>o1<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-1000"></a>      <font color=Green><u>let</u></font> <font color=Cyan>(</font>l3<font color=Cyan>,</font>o3<font color=Cyan>)</font> <font color=Red>=</font> simplRec' <font color=Cyan>$</font> alg_swap <font color=Cyan>(</font>l1<font color=Cyan>,</font>o1<font color=Cyan>)</font> <font color=Green><u>in</u></font>
<a name="line-1001"></a>      <font color=Green><u>let</u></font> <font color=Cyan>(</font>n<font color=Cyan>,</font>b<font color=Cyan>)</font> <font color=Red>=</font> is_equal_list l1 l3 <font color=Magenta>0</font> <font color=Green><u>in</u></font>
<a name="line-1002"></a>      <font color=Green><u>if</u></font> b <font color=Green><u>then</u></font> <font color=Cyan>(</font>l3<font color=Cyan>,</font>o3<font color=Cyan>)</font> 
<a name="line-1003"></a>      <font color=Green><u>else</u></font> trace <font color=Magenta>"Swapping!"</font> <font color=Cyan>$</font> simplRec <font color=Cyan>$</font> <font color=Cyan>(</font>l3<font color=Cyan>,</font>o3<font color=Cyan>)</font>
</pre>
</body>
</html>